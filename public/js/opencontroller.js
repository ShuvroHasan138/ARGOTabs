(function(){define(["jquery","filereader","alertcontroller","tournament","backends","localbackend","templates","jquery.transit"],function(a,b,c,d,e,f){var g;return g=function(){function b(b){var d,g,h,i,j=this;this.uiController=b,this.closeable=this.uiController.getTournament()!=null,new c({title:"Open tournament file",id:"open-modal",closeable:this.closeable,animated:this.closeable,buttons:this.closeable?["Cancel"]:[],primaryButtonIndex:-1,cancelButtonIndex:0,width:350,htmlMessage:templates.openModal()}),this.openModal=g=a("#open-modal"),g.find("#omodal-add-a1").click(function(){return g.find(".omodal-add-div").transition({x:"-33.33%"})}),g.find(".omodal-btn-close").click(function(){return j.resetAdd()}),g.find("#omodal-btn-new").click(function(){var b,c,e;return c=a("#omodal-add-page3").html(templates.openModalAddLocal),c.find(".omodal-btn-close").click(function(){return j.resetAdd()}),e=c.find(".omodal-text"),e.keypress(function(a){var b;if(a.which===13&&!e[0].readOnly){b=e[0].value;if(j.filenameAvailable(b,d))return e[0].readOnly=!0,j.newItem(b,f),j.resetAdd(),!1}return!0}),b=e.parent(),e.bind("input propertychange",function(){var a;return a=e[0].value,j.filenameAvailable(a,f)?b.removeClass("error"):b.addClass("error")}),g.find(".omodal-add-div").transition({x:"-66.66%"},function(){return e.focus()})}),this.fileLists={};for(h=0,i=e.length;h<i;h++)d=e[h],d.listFiles(function(a){var b,c,e,f;f=[];for(c=0,e=a.length;c<e;c++)b=a[c],f.push(j.addItem(b,d));return f});g.find("#omodal-btn-upload").click(function(){return g.find(".omodal-file").click()}),g.fileReaderJS(this.prepareFileReader()),g.find(".omodal-file").fileReaderJS(this.prepareFileReader())}return b.prototype.resetAdd=function(){var a,b=this;return a=this.openModal.find(".omodal-add-div"),a.transition({x:0},function(){return a.find("#omodal-add-page3").html("")})},b.prototype.addItem=function(b,c){var e,f,g,h,i,j,k,l=this;return h={name:b,icon:c.icon||'<i class="fa fa-fw fa-question"></i>'},g=this.fileLists[c],g==null&&(g=this.fileLists[c]={}),g[b]=!0,i=a(templates.openModalAddItem(h)),i.insertBefore(this.openModal.find("#open-modal-add-tr")),e=i.find(".omodal-edit-div"),j=i.find(".omodal-text"),f=j.parent(),j.keypress(function(a){var d,f;if(a.which===13&&!j[0].readOnly){f=j[0].value;if(j[0].ongoingDeletion){if(f==="confirm deletion of file")return(new c(b))["delete"](),delete g[b],i.remove(),j[0].readOnly=!0,e.transition({x:0}),!1}else{if(f===b)return j[0].readOnly=!0,e.transition({x:0}),!1;if(l.filenameAvailable(f,c))return d=new c(b),d.rename(f),j[0].readOnly=!0,delete g[b],g[f]=!0,i.find(".omodal-label").html(f),b=f,e.transition({x:0}),!1}}return!0}),j.bind("input propertychange",k=function(){var a,d,e;return a=j[0].value,d=j[0].ongoingDeletion,e=d?a==="confirm deletion of file":a===b||l.filenameAvailable(a,c),e?(f.removeClass("error"),d?f.addClass("success"):f.removeClass("success")):(f.removeClass("success"),f.addClass("error"))}),i.find(".omodal-btn-close").click(function(){return j[0].readOnly=!0,e.transition({x:0})}),i.find(".omodal-btn-edit").click(function(){return j[0].placeholder="Type the new file name",j[0].value=b,j[0].readOnly=!1,j[0].ongoingDeletion=!1,k(),e.transition({x:"-50%"},function(){return j.focus()})}),i.find(".omodal-btn-delete").click(function(){return j[0].placeholder='Type "confirm deletion of file"',j[0].value="",j[0].readOnly=!1,j[0].ongoingDeletion=!0,k(),e.transition({x:"-50%"},function(){return j.focus()})}),i.find(".omodal-a").click(function(){var a;return a=new d(new c(b)),l.openModal.modal("hide"),l.uiController.setTournament(a)})},b.prototype.newItem=function(a,b){var c,d=this;return c=new b(a),c.save(JSON.stringify({name:a}),function(){return d.addItem(a,b)})},b.prototype.filenameAvailable=function(a,b){var c;return a===""?!1:(c=this.fileLists[b],c==null?!0:!c[a])},b.prototype.prepareFileReader=function(){var a=this;return{dragClass:"dropbox",readAsDefault:"Text",readAsMap:{},on:{beforestart:function(a){return a.name.match(/\.atab$/)!=null},loadend:function(b,c){var d,e;e=c.name.match(/^(.*?)(\.atab)?$/)[1];while(!a.filenameAvailable(e,f))e=e+" (2)";return d=new f(e),d.save(b.target.result,function(){return a.addItem(e,f)})},groupend:function(){return a.resetAdd()}}}},b}()})}).call(this)
(function(){define(["jquery","filereader","alertcontroller","tournament","backends","localbackend","templates","jquery.transit"],function(e,t,n,r,o,i){var a;return a=function(){function t(t){var r,a,s,l,u=this;for(this.uiController=t,this.closeable=null!=this.uiController.getTournament(),new n({title:"Open tournament file",id:"open-modal",closeable:this.closeable,animated:this.closeable,buttons:this.closeable?["Cancel"]:[],primaryButtonIndex:-1,cancelButtonIndex:0,width:350,htmlMessage:templates.openModal()}),this.openModal=a=e("#open-modal"),a.find("#omodal-add-a1").click(function(){return a.find(".omodal-add-div").transition({x:"-33.33%"})}),a.find(".omodal-btn-close").click(function(){return u.resetAdd()}),a.find("#omodal-btn-new").click(function(){var t,n,o;return n=e("#omodal-add-page3").html(templates.openModalAddLocal),n.find(".omodal-btn-close").click(function(){return u.resetAdd()}),o=n.find(".omodal-text"),o.keypress(function(e){var t;return 13===e.which&&!o[0].readOnly&&(t=o[0].value,u.filenameAvailable(t,r))?(o[0].readOnly=!0,u.newItem(t,i),u.resetAdd(),!1):!0}),t=o.parent(),o.bind("input propertychange",function(){var e;return e=o[0].value,u.filenameAvailable(e,i)?t.removeClass("error"):t.addClass("error")}),a.find(".omodal-add-div").transition({x:"-66.66%"},function(){return o.focus()})}),this.fileLists={},s=0,l=o.length;l>s;s++)r=o[s],r.listFiles(function(e){var t,n,o,i;for(i=[],n=0,o=e.length;o>n;n++)t=e[n],i.push(u.addItem(t,r));return i});a.find("#omodal-btn-upload").click(function(){return a.find(".omodal-file").click()}),a.fileReaderJS(this.prepareFileReader()),a.find(".omodal-file").fileReaderJS(this.prepareFileReader())}return t.prototype.resetAdd=function(){var e;return e=this.openModal.find(".omodal-add-div"),e.transition({x:0},function(){return e.find("#omodal-add-page3").html("")})},t.prototype.addItem=function(t,n){var o,i,a,s,l,u,d,c=this;return s={name:t,icon:n.icon||'<i class="fa fa-fw fa-question"></i>'},a=this.fileLists[n],null==a&&(a=this.fileLists[n]={}),a[t]=!0,l=e(templates.openModalAddItem(s)),l.insertBefore(this.openModal.find("#open-modal-add-tr")),o=l.find(".omodal-edit-div"),u=l.find(".omodal-text"),i=u.parent(),u.keypress(function(e){var r,i;if(13===e.which&&!u[0].readOnly)if(i=u[0].value,u[0].ongoingDeletion){if("confirm deletion of file"===i)return new n(t)["delete"](),delete a[t],l.remove(),u[0].readOnly=!0,o.transition({x:0}),!1}else{if(i===t)return u[0].readOnly=!0,o.transition({x:0}),!1;if(c.filenameAvailable(i,n))return r=new n(t),r.rename(i),u[0].readOnly=!0,delete a[t],a[i]=!0,l.find(".omodal-label").html(i),t=i,o.transition({x:0}),!1}return!0}),u.bind("input propertychange",d=function(){var e,r,o;return e=u[0].value,r=u[0].ongoingDeletion,o=r?"confirm deletion of file"===e:e===t||c.filenameAvailable(e,n),o?(i.removeClass("error"),r?i.addClass("success"):i.removeClass("success")):(i.removeClass("success"),i.addClass("error"))}),l.find(".omodal-btn-close").click(function(){return u[0].readOnly=!0,o.transition({x:0})}),l.find(".omodal-btn-edit").click(function(){return u[0].placeholder="Type the new file name",u[0].value=t,u[0].readOnly=!1,u[0].ongoingDeletion=!1,d(),o.transition({x:"-50%"},function(){return u.focus()})}),l.find(".omodal-btn-delete").click(function(){return u[0].placeholder='Type "confirm deletion of file"',u[0].value="",u[0].readOnly=!1,u[0].ongoingDeletion=!0,d(),o.transition({x:"-50%"},function(){return u.focus()})}),l.find(".omodal-a").click(function(){var e;return e=new r(new n(t)),c.openModal.modal("hide"),c.uiController.setTournament(e)})},t.prototype.newItem=function(e,t){var n,r=this;return n=new t(e),n.save(JSON.stringify({name:e}),function(){return r.addItem(e,t)})},t.prototype.filenameAvailable=function(e,t){var n;return""===e?!1:(n=this.fileLists[t],null==n?!0:!n[e])},t.prototype.prepareFileReader=function(){var e=this;return{dragClass:"dropbox",readAsDefault:"Text",readAsMap:{},on:{beforestart:function(e){return null!=e.name.match(/\.atab$/)},loadend:function(t,n){var r,o;for(o=n.name.match(/^(.*?)(\.atab)?$/)[1];!e.filenameAvailable(o,i);)o+=" (2)";return r=new i(o),r.save(t.target.result,function(){return e.addItem(o,i)})},groupend:function(){return e.resetAdd()}}}},t}()})}).call(this);
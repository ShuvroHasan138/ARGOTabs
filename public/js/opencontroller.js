(function(){define(["jquery","filereader","alertcontroller","tournament","backends","localbackend","templates","jquery.transit"],function(a,b,c,d,e,f){var g;return g=function(){function b(b,d,g){var h,i,j,k,l=this;this.uiController=b,d==null&&(d=function(){}),g==null&&(g=function(){}),this.closeable=this.uiController.getTournament()!=null,new c({title:"Open tournament file",id:"open-modal",closeable:this.closeable,animated:this.closeable,buttons:this.closeable?["Cancel"]:[],primaryButtonIndex:-1,cancelButtonIndex:0,width:350,height:this.closeable?310:250,htmlMessage:templates.openModal(),onShow:d,onDismiss:g}),this.openModal=i=a("#open-modal"),i.find("#omodal-add-a1").click(function(){return i.find(".omodal-add-div").transition({x:"-33.33%"})}),i.find(".omodal-btn-close").click(function(){return l.resetAdd()}),i.find("#omodal-btn-new").click(function(){var b,c,d;return c=a("#omodal-add-page3").html(templates.openModalAddLocal),c.find(".omodal-btn-close").click(function(){return l.resetAdd()}),d=c.find(".omodal-text"),d.keypress(function(a){var b;if(a.which===13&&!d[0].readOnly){b=d[0].value;if(l.filenameAvailable(b,h))return d[0].readOnly=!0,l.newItem(b,f),l.resetAdd(),!1}return!0}),b=d.parent(),d.bind("input propertychange",function(){var a;return a=d[0].value,l.filenameAvailable(a,f)?b.removeClass("error"):b.addClass("error")}),i.find(".omodal-add-div").transition({x:"-66.66%"},function(){return d.focus()})}),this.fileLists={};for(j=0,k=e.length;j<k;j++)h=e[j],h.listFiles(function(a){var b,c,d,e;e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(l.addItem(b,h));return e});i.find("#omodal-btn-upload").click(function(){return i.find(".omodal-file").click()}),i.fileReaderJS(this.prepareFileReader()),i.find(".omodal-file").fileReaderJS(this.prepareFileReader())}return b.prototype.resetAdd=function(){var a,b=this;return a=this.openModal.find(".omodal-add-div"),a.transition({x:0},function(){return a.find("#omodal-add-page3").html("")})},b.prototype.addItem=function(b,c){var e,f,g,h,i,j,k,l=this;return h={name:b,icon:c.icon||'<i class="fa fa-fw fa-question"></i>'},g=this.fileLists[c],g==null&&(g=this.fileLists[c]={}),g[b]=!0,i=a(templates.openModalAddItem(h)),i.insertBefore(this.openModal.find("#open-modal-add-tr")),e=i.find(".omodal-edit-div"),j=i.find(".omodal-text"),f=j.parent(),j.keypress(function(d){var f,h,k,m;if(d.which===13&&!j[0].readOnly){m=j[0].value;if(j[0].ongoingDeletion){if(m==="confirm deletion of file")return h=new c(b),l.uiController.tournament!=null&&h.fileName()===l.uiController.tournament.backend.fileName()&&(l.uiController.setTournament(null),k=a("#open-modal .modal-footer .modal-cancel"),k.addClass("disabled"),k.css("pointer-events","none"),a("#open-modal .modal-header .modal-cancel").remove()),h["delete"](),delete g[b],i.remove(),j[0].readOnly=!0,e.transition({x:0}),!1}else{if(m===b)return j[0].readOnly=!0,e.transition({x:0}),!1;if(l.filenameAvailable(m,c))return f=new c(b),f.rename(m),j[0].readOnly=!0,delete g[b],g[m]=!0,i.find(".omodal-label").html(m),b=m,e.transition({x:0}),!1}}return!0}),j.bind("input propertychange",k=function(){var a,d,e;return a=j[0].value,d=j[0].ongoingDeletion,e=d?a==="confirm deletion of file":a===b||l.filenameAvailable(a,c),e?(f.removeClass("error"),d?f.addClass("success"):f.removeClass("success")):(f.removeClass("success"),f.addClass("error"))}),i.find(".omodal-btn-close").click(function(){return j[0].readOnly=!0,e.transition({x:0})}),i.find(".omodal-btn-edit").click(function(){return j[0].placeholder="Type the new file name",j[0].value=b,j[0].readOnly=!1,j[0].ongoingDeletion=!1,k(),e.transition({x:"-50%"},function(){return j.focus()})}),i.find(".omodal-btn-delete").click(function(){return j[0].placeholder='Type "confirm deletion of file"',j[0].value="",j[0].readOnly=!1,j[0].ongoingDeletion=!0,k(),e.transition({x:"-50%"},function(){return j.focus()})}),i.find(".omodal-a").click(function(){var a;return a=new d(new c(b)),l.openModal.modal("hide"),l.uiController.setTournament(a)})},b.prototype.newItem=function(a,b){var c,d=this;return c=new b(a),c.save(JSON.stringify({name:a}),function(){return d.addItem(a,b)})},b.prototype.filenameAvailable=function(a,b){var c;return a===""?!1:(c=this.fileLists[b],c==null?!0:!c[a])},b.prototype.prepareFileReader=function(){var a=this;return{dragClass:"dropbox",readAsDefault:"Text",readAsMap:{},on:{beforestart:function(a){return a.name.match(/\.atab$/)!=null},loadend:function(b,c){var d,e;e=c.name.match(/^(.*?)(\.atab)?$/)[1];while(!a.filenameAvailable(e,f))e=e+" (2)";return d=new f(e),d.save(b.target.result,function(){return a.addItem(e,f)})},groupend:function(){return a.resetAdd()}}}},b}()})}).call(this)
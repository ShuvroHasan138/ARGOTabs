!function(){define(["jquery","util","B64","underscore","templates","angular","jquery.event.drag","jquery.bootstrap.contextmenu","html2canvas"],function(e,t,n){var r,i,o;return i=angular.module("components",[]),i.directive("navLi",function(){return{restrict:"E",scope:{href:"@"},transclude:!0,replace:!0,controller:["$scope","$location",function(e,t){return e.$watch(function(){return t.path()},function(t){return e["class"]=t===e.href?"active":""})}],template:templates.navLi()}}),i.directive("sorterCriteria",[function(){return{template:templates.sorterCriteria(),restrict:"E",scope:{model:"=bind"}}}]),i.directive("textEditCell",["$parse",function(e){return{template:templates.textEditCell(),restrict:"E",scope:{extra:"@",minWidth:"@inputWidth",pattern:"@pattern",validator:"&",softValidator:"&",getter:"&",setter:"&",valid:"="},replace:!0,transclude:!0,link:function(n,r,i){var o,s,l,a;return n.editing=!1,a=r.find(".textedit-label"),l=r.find("input"),n.$watch(function(){return null==i.softValidator?!0:n.softValidator({o:e(i.bind)(n.$parent)})},function(e){return null!=i.valid&&(n.valid=e),e?(n.labelClass="valid",n.inputClass=""):(n.labelClass="invalid",n.inputClass="error")}),n.$watch(function(){return e(i.bind)(n.$parent)},function(e){return n.valueParsed=null!=i.getter?n.getter({o:e}):e}),n.$watch("valueParsed",function(t,r){var o;return o=null!=i.setter?n.setter({o:t}):t,n.pattern&&"string"==typeof t&&!t.match(new RegExp("^"+n.pattern+"$"))||null!=i.validator&&!n.validator({o:o})?n.valueParsed=r:e(i.bind).assign(n.$parent,o)}),n.$watch(function(){return i.editing},function(e,t){if(null!=e){if(e&&!t)return n.beginEdit();if(!e&&t)return n.endEdit()}}),n.$watch(function(){return null==i.enabled||n.$parent.$eval(i.enabled)},function(e){return n._enabled=e,e?a[0].tabIndex=0:a[0].removeAttribute("tabIndex")}),n.beginEdit_=function(){return null==i.editing&&n._enabled?n.beginEdit():void 0},s=function(){return t.safeApply(n,n.beginEdit_)},o=function(){return t.safeApply(n,function(){return null==i.editing?n.endEdit():void 0})},a.focus(s),"TD"===r.parent()[0].tagName&&r.parent().click(s),l.blur(o),l.keypress(function(e){return 13===e.which?o():void 0}),n.beginEdit=function(){var e,t;if(!n.editing)return n.editing=!0,e=parseInt(n.minWidth),isNaN(e)&&(e=100),t=a.outerWidth(),e>t&&(t=e),l.css("width",t),setTimeout(function(){return l.focus(),l.select()},0)},n.endEdit=function(){return n.editing=!1},i.editing?n.beginEdit():void 0}}}]),i.directive("multiCell",function(){return{template:templates.multiCell(),restrict:"E",scope:{value:"=bind",choiceName:"&choiceName",choices:"=choices",allowNil:"@nilPlaceholder",minWidth:"@inputWidth"},replace:!0,transclude:!0,compile:function(e,n){return n.nilPlaceholder||e.find("option").remove(),function(e,n,r){var i,o,s;return e.editing=!1,s=n.find("select"),o=n.find(".multi-label"),i=function(){return t.safeApply(e,function(){return e.beginEdit()})},o.focus(i),"TD"===n.parent()[0].tagName&&n.parent().click(i),s.blur(function(){return t.safeApply(e,function(){return e.endEdit()})}),e.beginEdit=function(){var t,n;if(!e.editing&&e._enabled)return e.editing=!0,t=parseInt(e.minWidth),isNaN(t)&&(t=100),n=o.outerWidth(),t>n&&(n=t),s.css("width",n),setTimeout(function(){return s.focus()},0)},e.endEdit=function(){return e.editing=!1},e.$watch(function(){return null==r.enabled||e.$parent.$eval(r.enabled)},function(t){return e._enabled=t,t?o[0].tabIndex=0:o[0].removeAttribute("tabIndex")}),e.getChoiceName=function(t){return null!=t?e.choiceName({o:t}):e.allowNil}}}}}),i.directive("hlistCell",["$parse",function(){return{template:templates.hlistCell(),restrict:"E",scope:{model:"=bind",addItem:"&addItem",removeItem:"&removeItem",editHidden:"=editHidden",separator:"@separator",reorders:"@reorders"},transclude:!0,link:function(n,r){var i,o,s,l,a,u,d,c,f;return n.edit=!1,n.remove=function(e){return n.removeItem({index:e}),n.model.length?void 0:n.edit=!1},n.add=function(){return n.addItem(),setTimeout(function(){var e;return(e=t.focusableElement(r.find(".item"),!1))?e.focus():void 0},1)},n.comma=function(e){return e?",":""},s=null,l=null,i=null,o=null,a=u=0,d=null,c=function(t,n){var i,o,s,l,a,u,d,c,f,h;for(a=r.find(".item"),s=f=0,h=a.length;h>f;s=++f)if(l=a[s],i=e(l),d=i.offset(),c=i.outerWidth(),o=i.outerHeight(),!(n<d.top||n>d.top+o||t<d.left||t>d.left+c))return u=d.left+c/2,{x:u>t?d.left:d.left+c,y:d.top,height:o,index:u>t?s:s+1};return null},f=function(e){var t;return i&&(i.css("left",e.pageX-a),i.css("top",e.pageY-u)),o?(t=c(e.pageX,e.pageY),!t||t.index!==d&&t.index!==d+1||(t=null),s&&!t?o.css("display","none"):t&&!s&&o.css("display","block"),t&&(o.css("left",t.x+"px"),o.css("top",t.y+"px"),o.css("height",t.height+"px")),s=t):void 0},r.on("draginit",function(t){var n,i;return i=e(t.target),l=null,i.hasClass("moveable-true")?l=i:(n=i.parents(".moveable-true")).length&&(l=n),l?r:!1}),r.on("dragstart",function(t){var n,r;return d=l.index(),n=window.pageXOffset,r=window.pageYOffset,html2canvas(l[0],{scale:window.devicePixelRatio?window.devicePixelRatio:1,onrendered:function(s){var d,c,h,p;window.scrollTo(n,r),c=l.outerWidth(),d=l.outerHeight(),p={x:s.width/c,y:s.height/d},i=e(s),i.css("width",c),i.css("height",d),i.css("position","absolute"),i.css("opacity","0.6"),h=l.offset(),a=t.pageX-h.left,u=t.pageY-h.top,l.css("opacity","0.4"),o=e(document.createElement("div")),o.css("position","absolute"),o.css("border","1px solid #0088cc"),o.css("border-radius","1px"),o.css("width","0px"),o.css("height","0px"),o.css("display","none"),e(document.body).append(o),e(document.body).append(i),f(t)}}),l}),r.on("drag",{distance:2},function(e){f(e)}),r.on("dragend",function(){var e;i&&(i.remove(),i=null),l.css("opacity","1"),o&&(o.remove(),o=null),s&&(e=s.index,e>d&&e--,e!==d&&t.safeApply(n,function(){var t,r;return t=n.model,r=t.splice(d,1)[0],t.splice(e,0,r)}))})}}}]),i.directive("sortArrow",function(){return{template:templates.sortArrow(),restrict:"E",scope:{model:"=",sortBy:"&",compareFunction:"&",hideArrows:"@"},replace:!0,transclude:!0,link:function(e,t){return e.ascending=!1,e.sort=function(){return e.sortBy?e.model=_.sortBy(e.model,function(t){return e.sortBy({o:t})}):e.compareFunction&&e.model.sort(function(t,n){return e.compareFunction({a:t,b:n})}),e.ascending?void 0:e.model.reverse()},e.elementToString=function(e){return e.hasClass("sortarrow")?r(t.find(".sortarrow-content")):!1},e.toggleSort=function(){return e.ascending=!e.ascending,e.sort()}}}}),r=function(t,n){var i,o,s;return null==n&&(n=!1),t.hasClass("dont-export")||n&&"none"===t.css("display")?"":(s=angular.element(t).scope(),s.elementToString&&(o=s.elementToString(t,n),o||"string"==typeof o)?o:(i=!1,o="",t.children().each(function(){var t;return t=r(e(this),n),t?(i&&(o+=" "),o+=t,i=!0):void 0}),i?o:t.text()))},o=function(t,n){var i;return null==n&&(n=!1),i=[],t.children().each(function(){var t;return t=e(this),t.hasClass("dont-export")||"TD"!==this.tagName&&"TH"!==this.tagName||n&&"none"===t.css("display")?void 0:i.push(r(t,n))}),i},i.directive("editableTable",["$parse",function(r){return{template:templates.editableTable(),restrict:"AE",replace:!0,transclude:!0,scope:{model:"=",addItem_:"&addItem",removeItem_:"&removeItem",canRemoveItem_:"&canRemoveItem",visible_:"@visible",reorders:"@reorders",tableClass_:"@tableClass",rowClicked_:"&rowClicked"},link:{post:function(i,s,l){var a,u,d,c,f,h,p,m,v;for(d=s.find("th").not(".controls"),h=d.length,a=e(templates.editableTcontext({id:i.tableId,n:h})).appendTo(e("body")),i.$watch(function(){return l.showGear},function(e){return i.showGear=null!=e?r(e)(i.$parent):!0}),i.$watch(function(){return l.tableClass},function(e){return i.tableClass=null!=e?e:"table table-striped table-bordered"}),i.$on("$destroy",function(){return a.remove()}),i.canRemoveItem=function(e){return null==l.canRemoveItem?null!=l.removeItem:i.canRemoveItem_({o:e})},c=function(){var t,r,i,l,a,u,d,c,f,h,p,m;for(r=[],s.find("tr").each(function(){var t;return t=e(this),t.hasClass("dont-export")?void 0:r.push(o(t,!0))}),c="",l=f=0,p=r.length;p>f;l=++f)for(d=r[l],l&&(c+="\r\n"),a=h=0,m=d.length;m>h;a=++h)t=d[a],a&&(c+=","),c+='"'+t.replace(/"/g,'""')+'"';return i=n.encode(c),u=e('<a id="downloader" download="table.csv" href="data:application/octet-stream;base64,'+i+'"></a>').appendTo(e("body")),u[0].click(),u.remove()},s.find("thead").contextmenu({target:".context-menu-"+i.tableId,before:function(t,n){var r;return r=o(n.find("tr")),a.find("li.hide-row").each(function(t,n){var o,s,l;return o=e(n),s=parseInt(o.data("index")),o.find(".item-label").html(r[s]),l=o.find("i"),i.visible[s]?(l.removeClass("icon-check-empty"),l.addClass("icon-check")):(l.removeClass("icon-check"),l.addClass("icon-check-empty"))}),!0},onItem:function(e,n){var r;return r=parseInt(n.data("index")),isNaN(r)&&(r=parseInt(n.parents("li").data("index"))),isNaN(r)?n.hasClass("export-csv")||n.parents(".export-csv")?c():void 0:t.safeApply(i,function(){return i.visible[r]=!i.visible[r],_.reduce(i.visible,function(e,t){return e||t},!1)?void 0:i.visible[r]=!i.visible[r]})}}),null==i.visible&&(i.visible=[]);i.visible.length<h;)i.visible.push(!0);for(i.$watch("visible_",function(e){var t,n,o,s;if(n=r(e),o=i.$parent,s=n(o),s&&s instanceof Array||!n.assign||(t=[],n.assign(o,t),s=t),s){for(;s.length<h;)s.push(!0);return i.visible=s}}),i.clearAutoCell=function(t){return null!==i.auto&&e(t[i.auto]).removeClass("a-width"),i.auto=null},i.updateAutoCell=function(t){var n,r,o,s,l,a,u,d;for(l=1000001,n=null,s=u=0,d=t.length;d>u;s=++u)if(o=t[s],i.visible[s]){if(r=e(o),r.hasClass("auto-width")){n=null;break}a=r.data("autoIndex"),isNaN(a)&&(a=1e6-r.width()),l>a&&(l=a,n=s)}return null!==n&&e(t[n]).addClass("a-width"),i.auto=n},v=[],f=p=0,m=d.length;m>p;f=++p)u=d[f],v.push(function(t,n){return i.$watch("visible["+t+"]",function(t){var r;return r=s.find("th").not(".controls"),i.clearAutoCell(r),i.updateAutoCell(r),t?e(n).removeClass("hidden-true"):e(n).addClass("hidden-true")}),i.$watch(function(){var r,o,s,l;if(!i.rowHovered)return 1;if(i.hover)return 1;if("none"===e(n).css("display"))return 1;for(r=o=s=t+1,l=d.length;l>=s?l>o:o>l;r=l>=s?++o:--o)if("none"!==e(d[r]).css("display"))return 1;return 2},function(e){return n.setAttribute("colspan",e)})}(f,u));return v}},controller:["$scope","$element",function(e){this.scope=e,e.tableId="tid"+Math.round(1e4*Math.random()),e.hover=!1,e.rowHovered=0}]}}]),i.directive("editableHeadTransclude",function(){return{require:"^editableTable",link:{post:function(n,r){return r.find("thead").hover(function(){return t.safeApply(n,function(){var t;if(n.showGear)return n.hover=!0,n.rowHovered++,n.headId="id"+Math.round(1e4*Math.random()),t=r.find("th:visible:last"),t.addClass("squeezedElement"),e(templates.editableTh({id:n.headId,tableId:n.tableId,width:t.width()})).appendTo(r.find("thead tr")).find("i.close.icon-cog").click(function(e){return setTimeout(function(){return r.find("thead").contextmenu("show",e)},1)})})},function(){return t.safeApply(n,function(){return n.hover?(n.hover=!1,n.rowHovered--,r.find(".controls").hide(),r.find(".squeezedElement").removeClass("squeezedElement"),r.find("#"+n.headId).remove()):void 0})})}},controller:["$transclude","$element",function(e,t){return e(function(e){return t.append(e)})}]}}),i.directive("editableTbody",function(){return{template:templates.editableTbody(),transclude:!0,restrict:"AE",require:"^editableTable",link:function(e,n,r,i){return e.getScope=function(){return i.scope},e.removeItem=function(e){var t;return t=i.scope.removeItem_,t?t({index:e}):i.scope.model.splice(e,1)},e.$watch(function(){return r.addItemLabel},function(){return e.addLabel=r.addItemLabel}),e.addItem=function(){return i.scope.addItem_(),setTimeout(function(){var e;return(e=t.focusableElement(n.find("tr:nth-last-child(2)")))?e.focus():void 0},1)},e.rowClicked=function(e){return i.scope.rowClicked_({$index:e})}}}}),i.directive("editableScriptTransclude",function(){return{require:"^editableTable",compile:function(n,r,i){return i(n,function(t){var r,i,o,s,l,a,u;for(r=e(t).filter("script").text().replace(/&lt;/gi,"<").replace(/&gt;/gi,">"),n.append(r),o=n.children("td").not(".controls"),u=[],s=l=0,a=o.length;a>l;s=++l)i=o[s],i.setAttribute("colspan","{{noColumns(hover, "+s+")}}"),u.push(e(i).addClass("hidden-{{!visible("+s+")}}"));return u}),{post:function(n,r,i,o){var s,l,a,u,d,c,f,h,p,m;return f=r.children("td").not(".controls"),n.noColumns=function(t,n){var r,i,s,l,a;if(t)return 1;if(!o.scope.rowHovered)return 1;if(r=f[n],"none"===e(r).css("display"))return 1;for(i=s=l=n+1,a=f.length;a>=l?a>s:s>a;i=a>=l?++s:--s)if("none"!==e(f[i]).css("display"))return 1;return 2},n.visible=function(e){try{return o.scope.visible[e]}catch(t){return!0}},n.mouseEnter=function(){var i;if(!n.hover&&o.scope.canRemoveItem(n.o))return n.hover=!0,o.scope.rowHovered++,n.id="id"+Math.round(1e4*Math.random()),i=r.find("td:visible:last"),i.addClass("squeezedElement"),e(templates.editableTd({id:n.id,width:i.width(),tableId:o.scope.tableId})).appendTo(r).find("i.close").click(function(){return t.safeApply(n,function(){return n.removeItem(n.$index)})})},n.mouseLeave=function(){return n.hover?(n.hover=!1,o.scope.rowHovered--,r.find(".squeezedElement").removeClass("squeezedElement"),r.find("#"+n.id).remove()):void 0},a=null,h=function(t,n){var i,o,s,l,a,u,d,c,f,h;if(c=r.parent(),h=c.children(),d=h.length-1,!d)return null;if(l=e(h[d-1]),a=l.offset().top+l.outerHeight(),n>a+10)return null;if(f=c.offset(),n<f.top-10)return null;if(t<f.left||t>f.left+c.outerWidth())return null;for(i=0,o=d;o>i;)u=i+o>>1,s=e(h[u]),n<s.offset().top+s.outerHeight()/2?o=u:i=u+1;return{index:o,y:o===d?a:e(h[o]).offset().top}},s=null,l=null,u=d=0,c=null,m=function(e){var t;return s&&(s.css("left",e.pageX-u),s.css("top",e.pageY-d)),l?(t=h(e.pageX,e.pageY),!t||t.index!==c&&t.index!==c+1||(t=null),a&&!t?l.css("display","none"):t&&!a&&l.css("display","block"),t&&l.css("top",t.y+"px"),a=t):void 0},p=o.scope,r.on("draginit",function(){return p.reorders?r:!1}),r.on("dragstart",function(t){var n,i,o;return p.reorders?(o=r.parents("table"),c=r.index(),n=window.pageXOffset,i=window.pageYOffset,html2canvas(r[0],{scale:window.devicePixelRatio?window.devicePixelRatio:1,onrendered:function(o){var a,c,f,h,p,v,g,b,y,w,C;window.scrollTo(n,i),v=o.getContext("2d"),b=function(e){var t;return t=parseInt(e),isNaN(t)?0:t},C=r.find("td:visible"),a={left:b(C.css("border-left-width"))+b(r.css("border-left-width")),right:b(C.last().css("border-right-width"))+b(r.css("border-right-width")),top:b(C.css("border-top-width"))+b(r.css("border-top-width")),bottom:b(C.css("border-bottom-width"))+b(r.css("border-bottom-width"))},y=r.offset(),p=r.outerWidth(),h=r.outerHeight(),w={x:o.width/p,y:o.height/h},f={width:p-a.left-a.right,height:h-a.top-a.bottom},y.left=a.left*w.x,y.top=a.top*w.y,y.width=f.width*w.x,y.height=f.height*w.y,c=document.createElement("canvas"),s=e(c),s.attr("width",y.width),s.attr("height",y.height),s.css("width",f.width),s.css("height",f.height),c.getContext("2d").drawImage(o,-y.left,-y.top),s.css("border","1px solid #dddddd"),s.css("position","absolute"),s.css("opacity","0.6"),g=r.offset(),u=t.pageX-g.left,d=t.pageY-g.top,r.css("opacity","0.4"),l=e(document.createElement("div")),l.css("position","absolute"),l.css("border","1px solid #0088cc"),l.css("border-radius","1px"),l.css("width",r.outerWidth()),l.css("left",r.offset().left),l.css("display","none"),m(t),e(document.body).append(l),e(document.body).append(s)}}),l):!1}),r.on("drag",{distance:4},function(e){m(e)}),r.on("dragend",function(){var e;s&&(s.remove(),s=null),r.css("opacity","1"),l&&(l.remove(),l=null),p.reorders&&a&&(e=a.index,e>c&&e--,e!==c&&t.safeApply(p,function(){var t,n;return t=p.model,n=t.splice(c,1)[0],t.splice(e,0,n)}))})}}}}})})}.call(this);
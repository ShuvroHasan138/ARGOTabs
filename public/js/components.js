(function(){define(["jquery","util","underscore","templates","angular","jquery.event.drag","html2canvas"],function(e,t){var n;return n=angular.module("components",[]),n.directive("navLi",function(){return{restrict:"E",scope:{href:"@"},transclude:!0,replace:!0,controller:["$scope","$location",function(e,t){return e.$watch(function(){return t.path()},function(t){return e["class"]=t===e.href?"active":""})}],template:templates.navLi()}}),n.directive("sorterCriteria",[function(){return{template:templates.sorterCriteria(),restrict:"E",scope:{model:"=bind"}}}]),n.directive("tristateCheckbox",["$parse",function(e){return{link:function(t,n,i){return t.$watch(function(){return e(i.tristateCheckbox)(t)},function(e){return null===e?(n.prop("indeterminate",!0),n.prop("checked",!0)):(n.prop("indeterminate",!1),n.prop("checked",e))}),n.bind("change",function(){var r,o,s;return s=e(i.tristateCheckbox),o=n.prop("indeterminate"),r=n.prop("checked"),o||r||!s(t)||(n.prop("indeterminate",o=!0),n.prop("checked",r=!0)),t.$apply(function(){return o?s.assign(t,null):s.assign(t,r)})})}}}]),n.directive("textEditCell",["$parse",function(e){return{template:templates.textEditCell(),restrict:"E",scope:{extra:"@",minWidth:"@inputWidth",pattern:"@pattern",validator:"&",softValidator:"&",getter:"&",setter:"&",valid:"="},replace:!0,transclude:!0,link:function(n,i,r){var o,s,u,l;return n.editing=!1,l=i.find(".textedit-label"),u=i.find("input"),n.$watch(function(){return null==r.softValidator?!0:n.softValidator({o:e(r.bind)(n.$parent)})},function(e){return null!=r.valid&&(n.valid=e),e?(n.labelClass="valid",n.inputClass=""):(n.labelClass="invalid",n.inputClass="error")}),n.$watch(function(){return e(r.bind)(n.$parent)},function(e){return n.valueParsed=null!=r.getter?n.getter({o:e}):e}),n.$watch("valueParsed",function(t,i){var o;return o=null!=r.setter?n.setter({o:t}):t,n.pattern&&"string"==typeof t&&!t.match(new RegExp("^"+n.pattern+"$"))||null!=r.validator&&!n.validator({o:o})?n.valueParsed=i:e(r.bind).assign(n.$parent,o)}),n.$watch(function(){return r.editing},function(e,t){if(null!=e){if(e&&!t)return n.beginEdit();if(!e&&t)return n.endEdit()}}),n.$watch(function(){return null==r.enabled||n.$parent.$eval(r.enabled)},function(e){return n._enabled=e,e?l[0].tabIndex=0:l[0].removeAttribute("tabIndex")}),n.beginEdit_=function(){return null==r.editing&&n._enabled?n.beginEdit():void 0},s=function(){return t.safeApply(n,n.beginEdit_)},o=function(){return t.safeApply(n,function(){return null==r.editing?n.endEdit():void 0})},l.focus(s),"TD"===i.parent()[0].tagName&&i.parent().click(s),u.blur(o),u.keypress(function(e){return 13===e.which?o():void 0}),n.beginEdit=function(){var e,t;if(!n.editing)return n.editing=!0,e=parseInt(n.minWidth),isNaN(e)&&(e=100),t=l.outerWidth(),e>t&&(t=e),u.css("width",t),setTimeout(function(){return u.focus(),u.select()},0)},n.endEdit=function(){return n.editing=!1},r.editing?n.beginEdit():void 0}}}]),n.directive("multiCell",function(){return{template:templates.multiCell(),restrict:"E",scope:{value:"=bind",choiceName:"&choiceName",choices:"=choices",allowNil:"@nilPlaceholder",minWidth:"@inputWidth"},replace:!0,transclude:!0,compile:function(e,n){return n.nilPlaceholder||e.find("option").remove(),function(e,n,i){var r,o,s;return e.editing=!1,s=n.find("select"),o=n.find(".multi-label"),r=function(){return t.safeApply(e,function(){return e.beginEdit()})},o.focus(r),"TD"===n.parent()[0].tagName&&n.parent().click(r),s.blur(function(){return t.safeApply(e,function(){return e.endEdit()})}),e.beginEdit=function(){var t,n;if(!e.editing&&e._enabled)return e.editing=!0,t=parseInt(e.minWidth),isNaN(t)&&(t=100),n=o.outerWidth(),t>n&&(n=t),s.css("width",n),setTimeout(function(){return s.focus()},0)},e.endEdit=function(){return e.editing=!1},e.$watch(function(){return null==i.enabled||e.$parent.$eval(i.enabled)},function(t){return e._enabled=t,t?o[0].tabIndex=0:o[0].removeAttribute("tabIndex")}),e.getChoiceName=function(t){return null!=t?e.choiceName({o:t}):e.allowNil}}}}}),n.directive("hlistCell",["$parse",function(){return{template:templates.hlistCell(),restrict:"E",scope:{model:"=bind",addItem:"&addItem",_addItemHidden:"&addItemHidden",removeItem:"&removeItem",_removeItemHidden:"&removeItemHidden",editHidden:"=editHidden",separator:"@separator",reorders:"&reorders",reordersAlways:"@reordersAlways",userdata:"&userdata",dropGroup:"@dropGroup",groupTest:"&groupTest",dropTest:"&dropTest",manualMove:"&manualMove",extensionElement:"@",extensionElementLast:"@"},transclude:!0,link:function(n,i,r){var o,s,u,l,a,d,c,p,h,f;return n.edit=!1,n.remove=function(e){return n.removeItem({index:e}),n.model.length?void 0:n.edit=!1},n.add=function(){return n.addItem(),setTimeout(function(){var e;return(e=t.focusableElement(i.find(".item"),!1))?e.focus():void 0},1)},n.comma=function(e){return e?",":""},n.$watch(function(){return null!=r.dropGroup},function(e){return n.hasGroup=e}),n.$watch(function(){return null!=r.addItem&&!(null!=r.addItemHidden&&n._addItemHidden())},function(e){return n.canAddItem=e}),n.$watch(function(){return null!=r.reorders&&n.reorders(n.$parent)},function(e){return n._reorders=e}),n.removeItemHidden=function(e,t){return null!=r.removeItemHidden?n._removeItemHidden({hlo:e,$index:t}):!1},l=null,a=null,o=null,s=null,d=c=0,p=null,u=function(){var t,o,s,u,l,a,d,c,p,h,f,m,g,v,y,b,w,x,C,k,j,I,E,$;for(b=n.rectangleList=[],v=function(e){return{ud:e.userdata(),model:e.model}},n.fromInstance=s=v(n),g=null==r.dropGroup?[i[0]]:e("hlist-cell"),$=[],x=0,j=g.length;j>x;x++)if(m=g[x],w=e(m).scope(),a=w===n?s:v(w),(null==r.dropGroup||w.dropGroup===n.dropGroup)&&(null==r.groupTest||n.groupTest({fromList:s,toList:a}))){for(l=b.length,c=e(m).find(".item"),c.length||c.push(e(m).find(".placeholder")[0]),u=C=0,I=c.length;I>C;u=++C)d=c[u],t=e(d),y=t.offset(),b.push({top:y.top,left:y.left,width:t.outerWidth(),height:t.outerHeight(),index:u,instance:a});if(l=b[l],h=b.length-1,p=b[h],e(c[0]).hasClass("placeholder")&&(l.empty=!0),null!=w.extensionElement&&""!==w.extensionElement)for(o=e(w.extensionElement),k=0,E=o.length;E>k;k++)d=o[k],t=e(d),y=t.offset(),b.push({top:y.top,left:y.left,width:t.outerWidth(),height:t.outerHeight(),lineTop:l.top,lineLeft:l.left,lineHeight:l.height,empty:!0,index:0,instance:a});null!=w.extensionElementLast&&""!==w.extensionElementLast?(o=e(w.extensionElementLast),$.push(function(){var n,i,r;for(r=[],n=0,i=o.length;i>n;n++)d=o[n],t=e(d),y=t.offset(),f=p.empty?p.left:p.left+p.width,r.push(b.push({top:y.top,left:y.left,width:t.outerWidth(),height:t.outerHeight(),lineTop:p.top,lineLeft:f,lineHeight:p.height,empty:!0,index:h,instance:a}));return r}())):$.push(void 0)}return $},h=function(e,t){var i,r,o,s,u,l,a,d,c,p;for(p=n.rectangleList,d=0,c=p.length;c>d;d++)if(u=p[d],a=u.width,i=u.height,l=u.top,r=u.left,!(l>t||t>l+i||r>e||e>r+a))return o=u.empty?r+a:r+a/2,s={x:o>e?r:r+a,y:l,height:i,index:u.index+(o>e?0:1),instance:u.instance},null!=u.lineTop&&(s.y=u.lineTop),null!=u.lineLeft&&(s.x=u.lineLeft),null!=u.lineHeight&&(s.height=u.lineHeight),s;return null},f=function(e){var t;return o&&(o.css("left",e.pageX-d),o.css("top",e.pageY-c)),s?(t=h(e.pageX,e.pageY),!t||t.instance!==n.fromInstance||t.index!==p&&t.index!==p+1||(t=null),l&&!t?s.css("display","none"):t&&!l&&s.css("display","block"),t&&(s.css("left",t.x+"px"),s.css("top",t.y+"px"),s.css("height",t.height+"px")),l=t):void 0},i.on("draginit",function(t){var n,r;return r=e(t.target),a=null,r.hasClass("moveable-true")?a=r:(n=r.parents(".moveable-true")).length&&(a=n),a?i:!1}),i.on("dragstart",function(t){var n,i;return p=a.index(),n=window.pageXOffset,i=window.pageYOffset,u(),html2canvas(a[0],{scale:window.devicePixelRatio?window.devicePixelRatio:1,onrendered:function(r){var u,l,p,h;window.scrollTo(n,i),l=a.outerWidth(),u=a.outerHeight(),h={x:r.width/l,y:r.height/u},o=e(r),o.css("width",l),o.css("height",u),o.css("position","absolute"),o.css("opacity","0.6"),p=a.offset(),d=t.pageX-p.left,c=t.pageY-p.top,a.css("opacity","0.4"),s=e(document.createElement("div")),s.css("position","absolute"),s.css("border","1px solid #0088cc"),s.css("border-radius","1px"),s.css("width","0px"),s.css("height","0px"),s.css("display","none"),e(document.body).append(s),e(document.body).append(o),f(t)}}),a}),i.on("drag",{distance:2},function(e){f(e)}),i.on("dragend",function(){var e,i;o&&(o.remove(),o=null),a.css("opacity","1"),s&&(s.remove(),s=null),l&&(null!=r.manualMove?t.safeApply(n,function(){return n.manualMove({fromList:n.fromInstance,toList:l.instance,fromIndex:p,toIndex:l.index})}):(e=l.index,i=l===n.fromInstance,i&&e>p&&e--,i&&e===p||t.safeApply(n,function(){var t;return t=n.model.splice(p,1)[0],l.instance.model.splice(e,0,t)})))})}}}])})}).call(this);
(function(){define(["jquery","util","jquery.transit","underscore","templates","angular","jquery.event.drag","html2canvas"],function(t,e){var n;return n=angular.module("components",[]),n.directive("navLi",function(){return{restrict:"E",scope:{href:"@"},transclude:!0,replace:!0,controller:["$scope","$location",function(t,e){return t.$watch(function(){return e.path()},function(e){return t["class"]=e===t.href?"active":""})}],template:templates.navLi()}}),n.directive("sorterCriteria",[function(){return{template:templates.sorterCriteria(),restrict:"E",scope:{model:"=bind",onUpdate:"&onUpdate"},link:function(t,n,i){return t.manualMove=function(n,r){return r!==n&&e.safeApply(t,function(){var e;return e=t.model.criteria.splice(n,1)[0],t.model.criteria.splice(r,0,e)}),null!=i.onUpdate?t.onUpdate():void 0}}}}]),n.directive("tristateCheckbox",["$parse",function(t){return{link:function(e,n,i){return e.$watch(function(){return t(i.tristateCheckbox)(e)},function(t){return null===t?(n.prop("indeterminate",!0),n.prop("checked",!0)):(n.prop("indeterminate",!1),n.prop("checked",t))}),n.bind("change",function(){var r,o,s;return s=t(i.tristateCheckbox),o=n.prop("indeterminate"),r=n.prop("checked"),o||r||!s(e)||(n.prop("indeterminate",o=!0),n.prop("checked",r=!0)),e.$apply(function(){return o?s.assign(e,null):s.assign(e,r)})})}}}]),n.directive("textEditCell",["$parse",function(t){return{template:templates.textEditCell(),restrict:"E",scope:{extra:"@",minWidth:"@inputWidth",pattern:"@pattern",validator:"&",softValidator:"&",getter:"&",setter:"&",valid:"="},replace:!0,transclude:!0,link:function(n,i,r){var o,s,l,u;return n.editing=!1,u=i.find(".textedit-label"),l=i.find("input"),n.$watch(function(){return null==r.softValidator?!0:n.softValidator({o:t(r.bind)(n.$parent)})},function(t){return null!=r.valid&&(n.valid=t),t?(n.labelClass="valid",n.inputClass=""):(n.labelClass="invalid",n.inputClass="error")}),n.$watch(function(){return t(r.bind)(n.$parent)},function(t){return n.valueParsed=null!=r.getter?n.getter({o:t}):t}),n.$watch("valueParsed",function(e,i){var o;return o=null!=r.setter?n.setter({o:e}):e,n.pattern&&"string"==typeof e&&!e.match(new RegExp("^"+n.pattern+"$"))||null!=r.validator&&!n.validator({o:o})?n.valueParsed=i:t(r.bind).assign(n.$parent,o)}),n.$watch(function(){return r.editing},function(t,e){if(null!=t){if(t&&!e)return n.beginEdit();if(!t&&e)return n.endEdit()}}),n.$watch(function(){return null==r.enabled||n.$parent.$eval(r.enabled)},function(t){return n._enabled=t,t?u[0].tabIndex=0:u[0].removeAttribute("tabIndex")}),n.beginEdit_=function(){return null==r.editing&&n._enabled?n.beginEdit():void 0},s=function(){return e.safeApply(n,n.beginEdit_)},o=function(){return e.safeApply(n,function(){return null==r.editing?n.endEdit():void 0})},u.focus(s),"TD"===i.parent()[0].tagName&&i.parent().click(s),l.blur(o),l.keypress(function(t){return 13===t.which?o():void 0}),n.beginEdit=function(){var t,e;if(!n.editing)return n.editing=!0,t=parseInt(n.minWidth),isNaN(t)&&(t=100),e=u.outerWidth(),t>e&&(e=t),l.css("width",e),setTimeout(function(){return l.focus(),l.select()},0)},n.endEdit=function(){return n.editing=!1},r.editing?n.beginEdit():void 0}}}]),n.directive("multiCell",function(){return{template:templates.multiCell(),restrict:"E",scope:{value:"=bind",choiceName:"&choiceName",choices:"=choices",allowNil:"@nilPlaceholder",minWidth:"@inputWidth"},replace:!0,transclude:!0,compile:function(t,n){return n.nilPlaceholder||t.find("option").remove(),function(t,n,i){var r,o,s;return t.editing=!1,s=n.find("select"),o=n.find(".multi-label"),r=function(){return e.safeApply(t,function(){return t.beginEdit()})},o.focus(r),"TD"===n.parent()[0].tagName&&n.parent().click(r),s.blur(function(){return e.safeApply(t,function(){return t.endEdit()})}),t.beginEdit=function(){var e,n;if(!t.editing&&t._enabled)return t.editing=!0,e=parseInt(t.minWidth),isNaN(e)&&(e=100),n=o.outerWidth(),e>n&&(n=e),s.css("width",n),setTimeout(function(){return s.focus()},0)},t.endEdit=function(){return t.editing=!1},t.$watch(function(){return null==i.enabled||t.$parent.$eval(i.enabled)},function(e){return t._enabled=e,e?o[0].tabIndex=0:o[0].removeAttribute("tabIndex")}),t.getChoiceName=function(e){return null!=e?t.choiceName({o:e}):t.allowNil}}}}}),n.directive("vlistCell",["$parse",function(){return{template:templates.vlistCell(),restrict:"E",scope:{model:"=bind",manualMove:"&manualMove"},transclude:!0,link:function(n,i,r){var o,s,l,u,a,d,c,p,h,f,m,g,v,y;return s=null,o=-1,h=-1,d=null,p=null,f=null,l=0,u=0,a=-1,y=0,c=0,i.on("draginit",function(e){var n,r,o;return r=t(e.target),s=null,d=null,r.hasClass("moveable-true")?d=r:(n=r.parents(".moveable-true")).length&&(d=n),d?(p=i.find(".item"),a=t.makeArray(p).indexOf(d[0]),s=d.find(".vlist-content"),o=s.offset(),l=e.pageX-o.left,u=e.pageY-o.top,i):!1}),g=function(e){var n,i,r,s,l,u,d;for(n=-1,r=u=0,d=p.length;d>u;r=++u)if(l=p[r],r!==a&&(i=t(l),s=i.offset(),s.left<=e.pageX&&e.pageX<=s.left+i.outerWidth()&&s.top<=e.pageY&&e.pageY<=s.top+i.outerHeight())){n=r;break}return n!==h&&n>=0&&(o>=a&&o++,o=n>=o?n+1:n,o>a&&o--),h=n},m=function(){},v=function(e){var n,i,r,d,h,m,v,y;if(s.css("left",e.pageX-l),s.css("top",e.pageY-u),d=o,g(e),o!==d){for(h=0,i=0,y=[],r=m=0,v=p.length;v>m;r=++m)n=p[r],r!==a&&(i===o&&(h+=c),i++,t(n).transition({top:h,duration:100}),y.push(h+=f[r].h));return y}},i.on("dragstart",function(e){var n,r,l,u,d,h,m,g,b;for(n=i.find(".vlist"),n.css("width",n.width()),n.css("height",n.height()),f=[],l=h=0,g=p.length;g>h;l=++h)d=p[l],r=t(d),u=r.position(),u.w=r.width(),u.h=r.height(),f.push(u);for(l=m=0,b=p.length;b>m;l=++m)d=p[l],r=t(d),u=f[l],r.css("width",u.w),r.css("height",u.h),r.css("top",u.top),r.css("left",u.left),r.css("position","absolute");return o=a,y=s.width(),c=s.height(),s.css("width",y),s.css("height",c),s.css("position","absolute"),t("body").append(s),v(e),s}),i.on("drag",{distance:2},function(t){v(t)}),i.on("dragend",function(){var l,u,c,h,f,m;for(c=f=0,m=p.length;m>f;c=++f)h=p[c],u=t(h),u.css("width",""),u.css("height",""),u.css("top",""),u.css("left",""),u.css("position","");d.append(s),s.css("width",""),s.css("height",""),s.css("position",""),l=i.find(".vlist"),l.css("width",""),l.css("height",""),null!=r.manualMove?e.safeApply(n,function(){return n.manualMove({from:a,to:o})}):o!==a&&e.safeApply(n,function(){return u=n.model.splice(a,1)[0],n.model.splice(o,0,u)})})}}}]),n.directive("hlistCell",["$parse",function(){return{template:templates.hlistCell(),restrict:"E",scope:{model:"=bind",addItem:"&addItem",_addItemHidden:"&addItemHidden",removeItem:"&removeItem",_removeItemHidden:"&removeItemHidden",editHidden:"=editHidden",separator:"@separator",reorders:"&reorders",reordersAlways:"@reordersAlways",userdata:"&userdata",dropGroup:"@dropGroup",groupTest:"&groupTest",dropTest:"&dropTest",manualMove:"&manualMove",extensionElement:"@",extensionElementLast:"@"},transclude:!0,link:function(n,i,r){var o,s,l,u,a,d,c,p,h,f;return n.edit=!1,n.remove=function(t){return n.removeItem({index:t}),n.model.length?void 0:n.edit=!1},n.add=function(){return n.addItem(),setTimeout(function(){var t;return(t=e.focusableElement(i.find(".item"),!1))?t.focus():void 0},1)},n.comma=function(t){return t?",":""},n.$watch(function(){return null!=r.dropGroup},function(t){return n.hasGroup=t}),n.$watch(function(){return null!=r.addItem&&!(null!=r.addItemHidden&&n._addItemHidden())},function(t){return n.canAddItem=t}),n.$watch(function(){return null!=r.reorders&&n.reorders(n.$parent)},function(t){return n._reorders=t}),n.removeItemHidden=function(t,e){return null!=r.removeItemHidden?n._removeItemHidden({hlo:t,$index:e}):!1},u=null,a=null,o=null,s=null,d=c=0,p=null,l=function(){var e,o,s,l,u,a,d,c,p,h,f,m,g,v,y,b,w,x,C,k,j,E,I,$;for(b=n.rectangleList=[],v=function(t){return{ud:t.userdata(),model:t.model}},n.fromInstance=s=v(n),g=null==r.dropGroup?[i[0]]:t("hlist-cell"),$=[],x=0,j=g.length;j>x;x++)if(m=g[x],w=t(m).scope(),a=w===n?s:v(w),(null==r.dropGroup||w.dropGroup===n.dropGroup)&&(null==r.groupTest||n.groupTest({fromList:s,toList:a}))){for(u=b.length,c=t(m).find(".item"),c.length||c.push(t(m).find(".placeholder")[0]),l=C=0,E=c.length;E>C;l=++C)d=c[l],e=t(d),y=e.offset(),b.push({top:y.top,left:y.left,width:e.outerWidth(),height:e.outerHeight(),index:l,instance:a});if(u=b[u],h=b.length-1,p=b[h],t(c[0]).hasClass("placeholder")&&(u.empty=!0),null!=w.extensionElement&&""!==w.extensionElement)for(o=t(w.extensionElement),k=0,I=o.length;I>k;k++)d=o[k],e=t(d),y=e.offset(),b.push({top:y.top,left:y.left,width:e.outerWidth(),height:e.outerHeight(),lineTop:u.top,lineLeft:u.left,lineHeight:u.height,empty:!0,index:0,instance:a});null!=w.extensionElementLast&&""!==w.extensionElementLast?(o=t(w.extensionElementLast),$.push(function(){var n,i,r;for(r=[],n=0,i=o.length;i>n;n++)d=o[n],e=t(d),y=e.offset(),f=p.empty?p.left:p.left+p.width,r.push(b.push({top:y.top,left:y.left,width:e.outerWidth(),height:e.outerHeight(),lineTop:p.top,lineLeft:f,lineHeight:p.height,empty:!0,index:h,instance:a}));return r}())):$.push(void 0)}return $},h=function(t,e){var i,r,o,s,l,u,a,d,c,p;for(p=n.rectangleList,d=0,c=p.length;c>d;d++)if(l=p[d],a=l.width,i=l.height,u=l.top,r=l.left,!(u>e||e>u+i||r>t||t>r+a))return o=l.empty?r+a:r+a/2,s={x:o>t?r:r+a,y:u,height:i,index:l.index+(o>t?0:1),instance:l.instance},null!=l.lineTop&&(s.y=l.lineTop),null!=l.lineLeft&&(s.x=l.lineLeft),null!=l.lineHeight&&(s.height=l.lineHeight),s;return null},f=function(t){var e;return o&&(o.css("left",t.pageX-d),o.css("top",t.pageY-c)),s?(e=h(t.pageX,t.pageY),!e||e.instance!==n.fromInstance||e.index!==p&&e.index!==p+1||(e=null),u&&!e?s.css("display","none"):e&&!u&&s.css("display","block"),e&&(s.css("left",e.x+"px"),s.css("top",e.y+"px"),s.css("height",e.height+"px")),u=e):void 0},i.on("draginit",function(e){var n,r;return r=t(e.target),a=null,r.hasClass("moveable-true")?a=r:(n=r.parents(".moveable-true")).length&&(a=n),a?i:!1}),i.on("dragstart",function(e){var n,i;return p=a.index(),n=window.pageXOffset,i=window.pageYOffset,l(),html2canvas(a[0],{scale:window.devicePixelRatio?window.devicePixelRatio:1,onrendered:function(r){var l,u,p,h;window.scrollTo(n,i),u=a.outerWidth(),l=a.outerHeight(),h={x:r.width/u,y:r.height/l},o=t(r),o.css("width",u),o.css("height",l),o.css("position","absolute"),o.css("opacity","0.6"),p=a.offset(),d=e.pageX-p.left,c=e.pageY-p.top,a.css("opacity","0.4"),s=t(document.createElement("div")),s.css("position","absolute"),s.css("border","1px solid #0088cc"),s.css("border-radius","1px"),s.css("width","0px"),s.css("height","0px"),s.css("display","none"),t(document.body).append(s),t(document.body).append(o),f(e)}}),a}),i.on("drag",{distance:2},function(t){f(t)}),i.on("dragend",function(){var t,i;o&&(o.remove(),o=null),a.css("opacity","1"),s&&(s.remove(),s=null),u&&(null!=r.manualMove?e.safeApply(n,function(){return n.manualMove({fromList:n.fromInstance,toList:u.instance,fromIndex:p,toIndex:u.index})}):(t=u.index,i=u===n.fromInstance,i&&t>p&&t--,i&&t===p||e.safeApply(n,function(){var e;return e=n.model.splice(p,1)[0],u.instance.model.splice(t,0,e)})))})}}}])})}).call(this);
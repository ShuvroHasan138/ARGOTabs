(function(){define(["util","player"],function(t,e){var n;return n=function(){function n(t,e){var n,r,o,i,s,a;if(this.tournament=t,e)for(n in e)o=e[n],this[n]=o;if(null==this.name&&(this.name=""),null==this.players&&(this.players=[]),null==this.rounds&&(this.rounds={}),!e)for(a=this.tournament.rounds,i=0,s=a.length;s>i;i++)r=a[i],r.registerTeam(this)}return n.prototype.unpackCycles=function(){var e,n,r,o,i;this.club=t.unpackCycle(this.club,this.tournament.clubs),t.unpackCycles(this.players,this.tournament.players),o=this.rounds,i=[];for(e in o)n=o[e],r=this.tournament.roundWithId(e),r&&null!=n.ballot?i.push(n.ballot=t.unpackCycle(n.ballot,r.ballots)):i.push(void 0);return i},n.prototype.toJSON=function(){var e,n,r,o,i,s;n=t.copyObject(this,["tournament","rounds","stats"]),n.club=t.packCycle(this.club,this.tournament.clubs),n.players=t.packCycles(this.players,this.tournament.players),n.rounds={},s=this.rounds;for(e in s)o=s[e],i=this.tournament.roundWithId(e),i&&(n.rounds[e]=r=t.copyObject(o),o.ballot&&(r.ballot=t.packCycle(o.ballot,i.ballots)));return n},n.calculateStats=function(t,e){var n,r,o,i,s,a,l,u,d,c,h;for(a=0,s=0,r=0,n=0,l=0,d=t.length;d>l;l++)i=t[l],o=i.stats=i.getStats(e),o.score>=0&&(a+=o.score,r++),o.reply>=0&&(s+=o.reply,n++);for(r?a/=r:a=245,n?s/=n:s=35,h=[],u=0,c=t.length;c>u;u++)i=t[u],o=i.stats,o.score<0&&(o.score<-2&&(o.scoreHighLow=a*-(o.score+2)),o.score*=-a),o.reply<0?h.push(o.reply*=-s):h.push(void 0);return h},n.prototype.getStats=function(t){var e,n,r,o,i,s,a,l,u,d,c,h,f,p,m,g,v,y;for(o={rawWins:0,rawScore:0,rawReply:0,rawBallots:0,byeWins:0,byeBallots:0,minScore:280,maxScore:0,wins:0,score:0,reply:0,scoreHighLow:0,ballots:0,roundsPlayed:0,roundsBotched:0,prop:0,opp:0},f=0,g=t.length;g>f;f++)if(a=t[f],"object"==typeof a&&(a=a.id),s=this.tournament.roundWithId(a),e=this.rounds[a].ballot,e.locked){if(this===e.teams[0])d=0;else{if(this!==e.teams[1])continue;d=1}if(e.presence[d])if(e.presence[1-d]&&e.teams[1-d]){for(o.roundsPlayed++,u=0,i=0,n=0,h=0,y=e.votes,p=0,v=y.length;v>p;p++){for(c=y[p],r=m=0;4>m;r=++m)u+=c.scores[d][r]*c.ballots;i+=c.scores[d][3]*c.ballots,n+=c.ballots,h+=d?c.opp:c.prop}h>n-h&&o.rawWins++,o.rawBallots+=h,n&&(u/=n,i/=n),o.rawScore+=u,o.rawReply+=i,u<o.minScore&&(o.minScore=u),u>o.maxScore&&(o.maxScore=u),d?o.opp++:o.prop++}else o.byeWins++,o.byeBallots+=s.ballotsPerMatchSolved();else o.roundsBotched++}return o.wins=o.rawWins+o.byeWins,o.ballots=o.rawBallots+o.byeBallots,l=o.roundsPlayed+o.roundsBotched,o.score=o.rawScore+o.byeWins*(l?o.rawScore/l:-1),o.reply=o.rawReply+o.byeWins*(l?o.rawReply/l:-1),o.byeWins+l>2&&l&&(o.scoreHighLow=o.score-o.minScore-o.maxScore),o.wins=o.rawWins+o.byeWins,o.ballots=o.rawBallots+o.byeBallots,o},n.prototype.addPlayer=function(){var t;return t=new e(this.tournament),this.players.push(t),this.tournament.players.push(t),t.team=this},n.prototype.removePlayer=function(t){var e;return e=this.players.indexOf(t),this.players.splice(e,1)},n.prototype.removePlayerAtIndex=function(t){var e,n,r;return r=this.players[t],this.players.splice(t,1),e=this.tournament.players,n=e.indexOf(r),e.splice(n,1)},n.prototype.destroy=function(){var t,e,n,r;for(r=this.tournament.rounds,e=0,n=r.length;n>e;e++)t=r[e],t.unregisterTeam(this);return this.club?this.club.removeTeam(this):void 0},n}()})}).call(this);
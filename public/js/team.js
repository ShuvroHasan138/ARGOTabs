(function(){define(["util","player"],function(t,e){var n;return n=function(){function n(t,e){var n,r,o,i,s,a;if(this.tournament=t,e)for(n in e)o=e[n],this[n]=o;if(null==this.name&&(this.name=""),null==this.players&&(this.players=[]),null==this.rounds&&(this.rounds={}),!e)for(a=this.tournament.rounds,i=0,s=a.length;s>i;i++)r=a[i],r.registerTeam(this)}return n.prototype.unpackCycles=function(){var e,n,r,o,i;this.club=t.unpackCycle(this.club,this.tournament.clubs),t.unpackCycles(this.players,this.tournament.players),o=this.rounds,i=[];for(e in o)n=o[e],r=this.tournament.roundWithId(e),r&&null!=n.ballot?i.push(n.ballot=t.unpackCycle(n.ballot,r.ballots)):i.push(void 0);return i},n.prototype.toJSON=function(){var e,n,r,o,i,s;n=t.copyObject(this,["tournament","rounds","stats"]),n.club=t.packCycle(this.club,this.tournament.clubs),n.players=t.packCycles(this.players,this.tournament.players),n.rounds={},s=this.rounds;for(e in s)o=s[e],i=this.tournament.roundWithId(e),i&&(n.rounds[e]=r=t.copyObject(o),o.ballot&&(r.ballot=t.packCycle(o.ballot,i.ballots)));return n},n.calculateStats=function(t,e){var n,r,o,i,s,a,l,u,d,c,h,f,p;for(u=0,a=0,l=0,o=0,n=0,r=0,d=0,h=t.length;h>d;d++)s=t[d],i=s.stats=s.getStats(e),i.score>=0&&(u+=i.score,o++),i.reply>=0&&(l+=i.reply,r++),i.scoreHighLow>=0&&(a+=i.scoreHighLow,n++);for(o?u/=o:u=245,n?a/=n:a=245,r?l/=r:l=35,p=[],c=0,f=t.length;f>c;c++)s=t[c],i=s.stats,i.score<0&&(i.score*=-u),i.scoreHighLow<0&&(i.scoreHighLow*=-a),i.reply<0?p.push(i.reply*=-l):p.push(void 0);return p},n.prototype.getStats=function(t){var e,n,r,o,i,s,a,l,u,d,c,h,f,p,m,g,v,b;for(o={rawWins:0,rawScore:0,rawReply:0,rawHLScore:0,rawHLRounds:0,rawBallots:0,byeWins:0,byeBallots:0,byeHLRounds:0,wins:0,score:0,reply:0,scoreHighLow:0,ballots:0,roundsPlayed:0,roundsBotched:0},f=0,g=t.length;g>f;f++)if(a=t[f],"object"==typeof a&&(a=a.id),s=this.tournament.roundWithId(a),e=this.rounds[a].ballot,e.locked){if(this===e.teams[0])d=0;else{if(this!==e.teams[1])continue;d=1}if(e.presence[d])if(e.presence[1-d]&&e.teams[1-d]){for(o.roundsPlayed++,u=0,i=0,n=0,h=0,b=e.votes,p=0,v=b.length;v>p;p++){for(c=b[p],r=m=0;4>m;r=++m)u+=c.scores[d][r]*c.ballots;i+=c.scores[d][3]*c.ballots,n+=c.ballots,h+=d?c.opp:c.prop}h>n-h&&o.rawWins++,o.rawBallots+=h,n&&(u/=n,i/=n),o.rawScore+=u,o.rawReply+=i}else o.byeWins++,o.byeBallots+=s.ballotsPerMatchSolved();else o.roundsBotched++}return o.wins=o.rawWins+o.byeWins,o.ballots=o.rawBallots+o.byeBallots,l=o.roundsPlayed+o.roundsBotched,o.score=o.rawScore+o.byeWins*(l?o.rawScore/l:-1),o.reply=o.rawReply+o.byeWins*(l?o.rawReply/l:-1),l=o.rawHLRounds,o.scoreHighLow=o.rawHLScore+o.byeHLRounds*(l?o.rawHLScore/l:-1),o.wins=o.rawWins+o.byeWins,o.ballots=o.rawBallots+o.byeBallots,o},n.prototype.addPlayer=function(){var t;return t=new e(this.tournament),this.players.push(t),this.tournament.players.push(t),t.team=this},n.prototype.removePlayer=function(t){var e;return e=this.players.indexOf(t),this.players.splice(e,1)},n.prototype.removePlayerAtIndex=function(t){var e,n,r;return r=this.players[t],this.players.splice(t,1),e=this.tournament.players,n=e.indexOf(r),e.splice(n,1)},n.prototype.destroy=function(){var t,e,n,r;for(r=this.tournament.rounds,e=0,n=r.length;n>e;e++)t=r[e],t.unregisterTeam(this);return this.club?this.club.removeTeam(this):void 0},n}()})}).call(this);
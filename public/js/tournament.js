(function(){define(["util","club","team","judge","room","player","round","sorter","judgerules"],function(a,b,c,d,e,f,g,h,i){var j;return j=function(){function j(a){this.backend=a,this.clubs=[]}return j.prototype.load=function(a){var j=this;return this.backend.load(function(k){var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ba,bb,bc;try{p=JSON.parse(k)}catch(bd){}p==null&&(p={}),j.clubs=[],j.teams=[],j.judges=[],j.rooms=[],j.players=[],j.rounds=[],j.tableOpts={},j.ballotsPerMatch=1,j.evenBrackets=0,j.matchesPerBracket=1,j.maxMainJudges=1e4,j.maxShadowJudges=1e4,j.maxPanelSize=1e4,j.judgeMainPriority=0,j.judgeMainOrder=0,j.judgeShadowPriority=0,j.judgeShadowOrder=0,j.judgeShadowReport=!1,j.minPlayed=1,j.allowShadows==null&&(j.allowShadows=!0),j.rankFromTeams==null&&(j.rankFromTeams={all:!0}),j.rankFromSpeakers==null&&(j.rankFromSpeakers={all:!0});for(o in p)u=p[o],j[o]=u;R=j.clubs;for(m=v=0,z=R.length;v<z;m=++v)l=R[m],j.clubs[m]=new b(j,l);S=j.teams;for(m=w=0,A=S.length;w<A;m=++w)t=S[m],j.teams[m]=new c(j,t);V=j.judges;for(m=x=0,D=V.length;x<D;m=++x)n=V[m],j.judges[m]=new d(j,n);W=j.rooms;for(m=y=0,E=W.length;y<E;m=++y)r=W[m],j.rooms[m]=new e(j,r);X=j.players;for(m=L=0,F=X.length;L<F;m=++L)q=X[m],j.players[m]=new f(j,q);Y=j.rounds;for(m=M=0,G=Y.length;M<G;m=++M)s=Y[m],j.rounds[m]=new g(j,s);Z=j.clubs;for(N=0,H=Z.length;N<H;N++)l=Z[N],l.unpackCycles();$=j.teams;for(O=0,I=$.length;O<I;O++)t=$[O],t.unpackCycles();_=j.judges;for(P=0,J=_.length;P<J;P++)n=_[P],n.unpackCycles();ba=j.rooms;for(Q=0,K=ba.length;Q<K;Q++)r=ba[Q],r.unpackCycles();T=j.players;for(bb=0,B=T.length;bb<B;bb++)q=T[bb],q.unpackCycles();U=j.rounds;for(bc=0,C=U.length;bc<C;bc++)s=U[bc],s.unpackCycles();j.speakerRankSorter=h.speakerRankSorter(p.speakerRankSorter),j.teamRankSorter=h.teamRankSorter(p.teamRankSorter),j.pairRankSorter=h.teamRankSorter(p.pairRankSorter),j.judgeRules=i.mainRules(j,p.judgeRules),j.lastData=j.toFile(),a()})},j.prototype.roundWithId=function(a){var b,c,d,e;typeof a=="string"&&(a=parseInt(a)),e=this.rounds;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.id===a)return b}return null},j.prototype.toJSON=function(){var b,c,d,e,f,g;b=a.copyObject(this,["backend","lastData"]),b.rankFromTeams={all:this.rankFromTeams.all},g=this.rounds;for(e=0,f=g.length;e<f;e++)c=g[e],d=this.rankFromTeams[c.id],d!=null&&(b.rankFromTeams[c.id]=d);return b},j.prototype.toFile=function(a){return a==null&&(a=!1),a?JSON.stringify(this,null,2):JSON.stringify(this)},j.prototype.save=function(a,b){return b==null&&(b=!1),this.saveData(this.toFile(),a,b)},j.prototype.saveIfRequired=function(a,b){var c;return b==null&&(b=!1),c=this.toFile(),this.lastData===c?!1:(this.saveData(c,a,b),!0)},j.prototype.saveData=function(a,b,c){var d=this;return c==null&&(c=!1),this.backend.save(a,function(){return d.lastData=a,b()},c)},j.prototype.clubWithName=function(a){var b,c,d,e;e=this.clubs;for(c=0,d=e.length;c<d;c++){b=e[c],console.log(b.name,a);if(b.name===a)return b}return null},j.prototype.addClub=function(a){var c;return console.log("addClub",a),c=new b(this),this.clubs.push(c),c.name=a,c},j.prototype.addTeam=function(a,b,d){var e,f,g,h,i,j;e=this.clubWithName(b),e==null&&(e=this.addClub(b)),h=new c(this),h.name=a,h.club=e,e.addTeam(h);for(i=0,j=d.length;i<j;i++)f=d[i],g=h.addPlayer(),g.name=f;return this.teams.push(h),h},j.prototype.addJudge=function(a,b,c){var e,f;return c==null&&(c=0),e=this.clubWithName(b),e==null&&(e=this.addClub(b)),c===-1&&(c=d.shadowRank),f=new d(this),f.name=a,f.club=e,f.rank=c,e.addJudge(f),this.judges.push(f),f},j.prototype.destroyEntityInJudgeRules=function(a){var b,c,d,e,f;this.judgeRules.entityDestroyed(a),e=this.rounds,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b.judgeRules.entityDestroyed(a));return f},j}()})}).call(this)
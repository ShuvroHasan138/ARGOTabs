!function(){define(["team","judge","round","util","alertcontroller"],function(t,e,n,r,o){return function(t,i){return i.when("/rounds/:roundIndex",{templateUrl:"partials/rounds.html",controller:["$scope","$routeParams","$compile",function(t,i,a){var s,l,u,c,d,p,f;for(l=i.roundIndex-1,u=t.round=t.tournament.rounds[l],t.ranks=e.ranks,t.rankStrings=e.rankStrings,t.ballotsPerMatchOptions=[1,3,5,7,9],t.infinity=1e4,t.maxPanelChoices=[t.infinity,0,1,2,3,4,5,6,7,8,9],t.infinityName=function(t,e,n){return t===e?n:t},t.parseInt=function(t){return""===t?0:parseInt(t)},t.parseFloat=function(t){return""===t?0:parseFloat(t)},t.truncFloat=function(t,e){var n;return n=t.toFixed(e),-1!==n.indexOf(".")?n.replace(/\.?0*$/,""):n},t.validateMinMax=function(t,e,n){return t>=e&&n>=t},t.addAllTeams=function(){var e,n,r,o,i;for(o=t.tournament.teams,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.rounds[u.id].participates=!0);return i},t.removeAllTeams=function(){var e,n,r,o,i;for(o=t.tournament.teams,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.rounds[u.id].participates=!1);return i},t.addAllJudges=function(){var e,n,r,o,i;for(o=t.tournament.judges,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.rounds[u.id].participates=!0);return i},t.removeAllJudges=function(){var e,n,r,o,i;for(o=t.tournament.judges,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.rounds[u.id].participates=!1);return i},t.removeShadows=function(){var n,r,o,i,a;for(i=t.tournament.judges,a=[],r=0,o=i.length;o>r;r++)n=i[r],n.rank===e.shadowRank?a.push(n.rounds[u.id].participates=!1):a.push(void 0);return a},t.addAllRooms=function(){var e,n,r,o,i;for(o=t.tournament.rooms,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.rounds[u.id].participates=!0);return i},t.removeAllRooms=function(){var e,n,r,o,i;for(o=t.tournament.rooms,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.rounds[u.id].participates=!1);return i},t.sortByRank=function(){return u.sortByRank(u.teams)},t.shuffleRooms=function(){return u.shuffleRooms()},c=function(t){var e,n,r,o,i,a,s,l,u,c,d,p,f;if(r=null!=t.teams[0]&&t.presence[0],o=null!=t.teams[1]&&t.presence[1],r||o)if(r&&o)if(t.locked){for(i=[0,0],l=[0,0],a=u=0;1>=u;a=++u){for(e=0,f=t.votes,c=0,p=f.length;p>c;c++){for(s=f[c],n=d=0;4>d;n=++d)i[a]+=s.scores[a][n]*s.ballots;l[a]+=a?s.opp:s.prop,e+=s.ballots}i[a]/=e}t.stats={scores:i,winClass:l[0]>l[1]?"prop":"opp",classes:["",""]}}else t.stats={scores:["unfilled",""],winClass:"hidden-true",classes:["muted-true",""]};else t.stats={scores:["default win",""],winClass:"hidden-true",classes:[r?"prop":"opp","hidden-true"]};else t.stats={scores:["not played",""],winClass:"hidden-true",classes:["","hidden-true"]}},f=u.ballots,d=0,p=f.length;p>d;d++)s=f[d],c(s);return t.assignJudges=function(){return u.assignJudges()},t.pair=function(){var e;return t.pairOpts={algorithm:0,shuffle:!1,balance:!0,brackets:1},e=t.prevRounds=u.previousRounds(),t.pairAlgorithms=e.length?n.allAlgos:n.initialAlgos,t.algoName=n.algoName,t.parseInt=function(t){return""===t?0:parseInt(t)},t.pairingTeams=u.pairingTeams(),t.manualPairing=[],new o({buttons:["Cancel","Ok"],cancelButtonIndex:0,title:"Round "+(l+1)+" pairing",htmlMessage:a(templates.pairModal())(t),onClick:function(e,n){var o;if(1===n){if(o=t.pairOpts,1===o.algorithm){if(t.pairingTeams.length)return e.find(".error-placeholder").html(templates.errorAlert({error:"You must pair all the teams before continuing"})),void 0;o.manualPairing=t.manualPairing}return e.modal("hide"),r.safeApply(t,function(){var t,e,n,r;for(u.pair(o),n=u.ballots,r=[],t=0,e=n.length;e>t;t++)s=n[t],r.push(c(s));return r})}}})},t.addTeamToManualPairing=function(e,n){var r,o;if(t.incompletePairing)if(o=t.incompletePairing,t.incompletePairing=null,o.prop){if(o.opp)return;o.opp=e}else o.prop=e;else o=t.incompletePairing={prop:e},t.manualPairing.push(o),r=$(".manual-pairings .span8"),r.animate({scrollTop:r[0].scrollHeight},500);return t.pairingTeams.splice(n,1)},t.removePairFromManualPairing=function(e,n){return e.prop?e.opp?t.pairingTeams.splice(0,0,e.prop,e.opp):t.pairingTeams.splice(0,0,e.prop):t.pairingTeams.splice(0,0,e.opp),t.manualPairing.splice(n,1),e===t.incompletePairing?t.incompletePairing=null:void 0},t.reverseSidesInManualPairing=function(t){var e;return e=t.prop,t.prop=t.opp,t.opp=e},t.editBallot=function(e){var n,r,i,s,l,d,p,f,h,m,v,g,y;if(p=t.$new(),n=u.ballots[e],null!==n.prop&&null!==n.opp){for(l=u.ballotsPerMatchSolved(),p.votes=n.getVotesForBallots(l),p.speakers=[n.teams[0].players,n.teams[1].players],s=p.votes.length,p.winner=function(t){return t.prop>t.opp?"prop":"opp"},p.roles=n.getSpeakerRoles(),p.presence=[n.presence[0],n.presence[1]],p.sides=["Prop","Opp"],p.sidesClass=["prop","opp"],p.validPlayer=function(t,e){var n,r,o;for(n=0,r=o=0;2>=o;r=++o)e[r]===t&&n++;return n},l=0,h=function(t){var e,r;return r=p.votes[t],e=r.ballots,l+=e,r.judge||n.locked||(p.noJudgesWarning=!0),r.aux={decisionValid:!0,validSplits:[_.range((e/2>>0)+1,e+1),_.range((e/2>>0)+1)],winner:0},p.$watch(function(){return r.prop},function(){return r.opp=r.ballots-r.prop}),p.$watch(function(){return r.opp},function(){return r.prop=r.ballots-r.opp}),p.$watch(function(){return d(r)},function(t){var e,n;return r.aux.decisionValid=!0,r.prop>r.opp?(n=r.prop,e=r.opp):(n=r.opp,e=r.prop),0===t?(r.prop=n,r.opp=e,r.aux.winner=0):1===t?(r.prop=e,r.opp=n,r.aux.winner=1):r.aux.decisionValid=!1})},r=v=0;s>=0?s>v:v>s;r=s>=0?++v:--v)h(r);if(p.lockJudgesInfo=!n.locked&&!p.noJudgesWarning,s>1){for(p.votes.push(f={judge:{name:"Total"},scores:[[70,70,70,35],[70,70,70,35]],total:!0,aux:{decisionValid:!0,validSplits:[_.range((l/2>>0)+1,l+1),_.range((l/2>>0)+1)],winner:0}}),r=g=0;2>g;r=++g)for(m=function(t,e){return p.$watch(function(){var n,r,o,i,a;for(n=0,a=p.votes,i=0,o=a.length;o>i;i++)r=a[i],r.total||(n+=r.scores[t][e]*r.ballots);return n/l},function(n){return f.scores[t][e]=n})},i=y=0;4>y;i=++y)m(r,i);p.$watch(function(){var t,e,n,r,o;for(t=0,o=p.votes,r=0,n=o.length;n>r;r++)e=o[r],e.total||(t+=e.prop);return t},function(t){return f.prop=t}),p.$watch(function(){var t,e,n,r,o;for(t=0,o=p.votes,r=0,n=o.length;n>r;r++)e=o[r],e.total||(t+=e.opp);return t},function(t){return f.opp=t}),p.$watch(function(){var t,e;for(t=e=0;s>=0?s>e:e>s;t=s>=0?++e:--e)if(!p.votes[t].aux.decisionValid)return!1;return!0},function(t){return p.votes[s].aux.decisionValid=t})}return d=function(t){var e,n,r,o;return n=t.scores[0],e=t.scores[1],o=n[0]+n[1]+n[2]+n[3],r=e[0]+e[1]+e[2]+e[3],o>r?0:r>o?1:2},new o({buttons:["Cancel","Ok"],cancelButtonIndex:0,width:700,title:'<span class="prop">'+n.teams[0].name+'</span><span> vs. </span><span class="opp">'+n.teams[1].name+"</span>",htmlMessage:a(templates.ballotSheet())(p),onClick:function(e,o){var a,s,l,u,d,f,h,m,v,g,y,b;if(p.$apply(function(){return p.drawsError=!1,p.outOfRangeError=!1}),u=!1,s=p.presence[0]&&p.presence[1],1===o){for(y=p.votes,h=0,d=y.length;d>h;h++)if(l=y[h],!l.total){for(r=m=0;1>=m;r=++m){for(i=v=0;2>=v;i=++v)if(a=l.scores[r][i],(60>a||a>80)&&(u=!0,s))return p.$apply(function(){return p.outOfRangeError=!0}),void 0;if(a=l.scores[r][3],(30>a||a>40)&&(u=!0,s))return p.$apply(function(){return p.outOfRangeError=!0}),void 0}if(!l.aux.decisionValid&&(u=!0,s))return p.$apply(function(){return p.drawsError=!0}),void 0}for(u||(n.votes=_.filter(p.votes,function(t){return!t.total})),n.roles=[p.roles[0].roles,p.roles[1].roles],n.presence=[p.presence[0],p.presence[1]],p.$destroy(),p=null,b=n.votes,g=0,f=b.length;f>g;g++)l=b[g],delete l.aux;return n.locked=!0,t.$apply(function(){return c(n)}),e.modal("hide")}},onDismissed:function(){return null!=p?p.$destroy():void 0}})}},t.eliminateNil=function(t){return null==t?"":t},t.namePlaceholder=function(t,e){return null==e&&(e=""),null==t?{name:e}:t},t.nilPlaceholder=function(t,e){return null==t?e:t}}]})}})}.call(this);
(function(){define(["team","judge","round","util","alertcontroller"],function(t,e,n,r,o){return function(t,i){return i.when("/rounds/:roundIndex",{templateUrl:"partials/rounds.html",controller:["$scope","$routeParams","$compile",function(t,i,s){var a,l,u,c,d,h,p,f,m,g,v,y,b,w,k,S,C,x,j;for(l=i.roundIndex-1,d=t.round=t.tournament.rounds[l],t.ranks=e.ranks,t.rankStrings=e.rankStrings,t.ballotsPerMatchOptions=[1,3,5,7,9],t.infinity=1e4,t.maxPanelChoices=[t.infinity,0,1,2,3,4,5,6,7,8,9],t.infinityName=function(t,e,n){return t===e?n:t},t.priorityChoices=[0,1],t.priorityChoiceNames=["Assign good judges to good teams","Assign good judges to weak teams"],t.orderChoices=[0,1],t.orderChoiceNames=["Assign judges to good teams first","Assign judges to weak teams first"],r.installScopeUtils(t),j=t.truncFloat,t.truncFloatN=function(t,e){return"number"==typeof t?j(t,e):t},S=d.judges,f=function(e){return t.$watch(function(){var t;return t=e.rounds[d.id],null!=t?t.participates:null},function(t,n){var o;null!=t&&t!==n&&(t?d.freeJudges.push(e):(o=e.rounds[d.id],null!=o&&o.ballot&&!o.ballot.locked?(o.shadow?r.arrayRemove(o.ballot.shadows,e):r.arrayRemove(o.ballot.judges,e),o.ballot=null):r.arrayRemove(d.freeJudges,e)))})},g=0,b=S.length;b>g;g++)u=S[g],f(u);for(C=d.rooms,m=function(e){return t.$watch(function(){var t;return t=e.rounds[d.id],null!=t?t.participates:null},function(t,n){var o;null!=t&&t!==n&&(t?d.freeRooms.push(e):(o=e.rounds[d.id],null!=o&&o.ballot?(o.ballot.room=null,o.ballot=null):r.arrayRemove(d.freeRooms,e)))})},v=0,w=C.length;w>v;v++)c=C[v],m(c);for(t.addAllTeams=function(){var e,n,r,o,i;for(o=t.tournament.teams,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.rounds[d.id].participates=!0);return i},t.removeAllTeams=function(){var e,n,r,o,i;for(o=t.tournament.teams,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.rounds[d.id].participates=!1);return i},t.addAllJudges=function(){var e,n,r,o,i;for(o=t.tournament.judges,i=[],n=0,r=o.length;r>n;n++)u=o[n],e=u.rounds[d.id],null!=e.ballot&&e.ballot.locked||i.push(e.participates=!0);return i},t.removeAllJudges=function(){var e,n,r,o,i;for(o=t.tournament.judges,i=[],n=0,r=o.length;r>n;n++)u=o[n],e=u.rounds[d.id],null!=e.ballot&&e.ballot.locked||i.push(e.participates=!1);return i},t.removeShadows=function(){var n,r,o,i,s;for(i=t.tournament.judges,s=[],r=0,o=i.length;o>r;r++)if(u=i[r],u.rank===e.shadowRank){if(n=u.rounds[d.id],null!=n.ballot&&n.ballot.locked)continue;s.push(n.participates=!1)}else s.push(void 0);return s},t.addAllRooms=function(){var e,n,r,o;for(r=t.tournament.rooms,o=[],e=0,n=r.length;n>e;e++)c=r[e],o.push(c.rounds[d.id].participates=!0);return o},t.removeAllRooms=function(){var e,n,r,o;for(r=t.tournament.rooms,o=[],e=0,n=r.length;n>e;e++)c=r[e],o.push(c.rounds[d.id].participates=!1);return o},t.sortByRank=function(){return d.sortByRank(d.teams)},t.shuffleRooms=function(){return d.shuffleRooms()},t.sortBallots=function(){return d.sortBallots()},t.judgeUd=function(t,e){return{ballot:t,shadow:e}},t.judgeGroupTest=function(t,e){var n;return n=e.ud.ballot,null==n?!0:t===e?!0:!n.locked&&n.teams[0]&&n.teams[1]?e.ud.shadow||n.judges.length<d.ballotsPerMatchSolved():!1},t.isCompatible=function(t,e){return console.log(t,e),!1},t.judgeMove=function(t,e,n,r){var o,i;return t===n&&r>e&&r--,o=t.model.splice(e,1)[0],n.model.splice(r,0,o),i=o.rounds[d.id],i.ballot=n.ud.ballot,i.shadow=n.ud.shadow},h=function(e){var n,o,i,s,a,l,u,c,h,p,f,m,g,v,y,b;if(null==t.scoreDecimals&&(t.scoreDecimals=0),l=t.scoreDecimals,s=function(t){var e,n;return e=r.decimalsOf(t[0],2),n=r.decimalsOf(t[1],2),n>e?n:e},c=!0,u=!0,e&&(o=s(e),o===l?(c=!1,u=!1):o>l&&(t.scoreDecimals=l=o,u=!1)),u){for(i=0,v=d.ballots,p=0,m=v.length;m>p;p++)n=v[p],a=n.stats.rawScores,null!=a&&(o=s(a),o>i&&(i=o));l===i?c=!1:t.scoreDecimals=l=i}if(c){for(y=d.ballots,b=[],f=0,g=y.length;g>f;f++)n=y[f],h=n.stats,null!=h.rawScores&&b.push(h.scores=[h.rawScores[0].toFixed(l),h.rawScores[1].toFixed(l)]);return b}},p=function(e,n){var r,o,i,s,a,l,u,c,d,p,f,m,g,v;if(null==n&&(n=!0),s=null!=e.teams[0]&&e.presence[0],a=null!=e.teams[1]&&e.presence[1],s||a)if(s&&a)if(e.locked){for(l=[0,0],d=[0,0],u=p=0;1>=p;u=++p){for(r=0,v=e.votes,f=0,m=v.length;m>f;f++){for(c=v[f],i=g=0;4>g;i=++g)l[u]+=c.scores[u][i]*c.ballots;d[u]+=u?c.opp:c.prop,r+=c.ballots}l[u]/=r}o=t.scoreDecimals,e.stats={scores:[l[0].toFixed(o),l[1].toFixed(o)],rawScores:l,winClass:d[0]>d[1]?"prop":"opp",classes:["",""]},n&&h(l)}else e.stats={scores:["unfilled",""],winClass:"hidden-true",classes:["muted-true",""]};else e.stats={scores:["default win",""],winClass:"hidden-true",classes:[s?"prop":"opp","hidden-true"]};else e.stats={scores:["not played",""],winClass:"hidden-true",classes:["","hidden-true"]}},x=d.ballots,y=0,k=x.length;k>y;y++)a=x[y],p(a,!1);return h(),t.assignJudges=function(){return d.assignJudges()},t.assignRooms=function(){return d.assignRooms()},t.pair=function(){var e,i,u,c,h,f;for(t.pairOpts={algorithm:0,sides:0,manualSides:!0,shuffleRooms:!0,hardSides:!0,minimizeReMeet:!0,matchesPerBracket:d.tournament.matchesPerBracket,evenBrackets:d.tournament.evenBrackets},i=t.prevRounds=d.previousRounds(),t.pairAlgorithms=i.length?n.allAlgos:n.initialAlgos,t.algoName=n.algoName,t.pairingTeams=d.pairingTeams(),t.manualPairing=[],c=t.sides=[0,1],h=0,f=i.length;f>h;h++)u=i[h],e=u.getName(),c.push({roundId:u.id,name:"Same as "+e,flip:!1}),c.push({roundId:u.id,name:"Opposite from "+e,flip:!0});return t.sidesName=function(t){return 0===t?"Random":1===t?"Balanced":t.name},new o({buttons:["Cancel","Ok"],cancelButtonIndex:0,title:"Round "+(l+1)+" pairing",htmlMessage:s(templates.pairModal())(t),onClick:function(e,n){var o;if(1===n){if(o=t.pairOpts,1===o.algorithm){if(t.pairingTeams.length)return e.find(".error-placeholder").html(templates.errorAlert({error:"You must pair all the teams before continuing"})),void 0;o.manualPairing=t.manualPairing}return e.modal("hide"),r.safeApply(t,function(){var t,e,n,r;for(d.pair(o),n=d.ballots,r=[],e=0,t=n.length;t>e;e++)a=n[e],r.push(p(a));return r})}}})},t.addTeamToManualPairing=function(e,n){var r,o;if(t.incompletePairing)if(o=t.incompletePairing,t.incompletePairing=null,o.prop){if(o.opp)return;o.opp=e}else o.prop=e;else o=t.incompletePairing={prop:e},t.manualPairing.push(o),r=$(".manual-pairings .span8"),r.animate({scrollTop:r[0].scrollHeight},500);return t.pairingTeams.splice(n,1)},t.removePairFromManualPairing=function(e,n){return e.prop?e.opp?t.pairingTeams.splice(0,0,e.prop,e.opp):t.pairingTeams.splice(0,0,e.prop):t.pairingTeams.splice(0,0,e.opp),t.manualPairing.splice(n,1),e===t.incompletePairing?t.incompletePairing=null:void 0},t.reverseSidesInManualPairing=function(t){var e;return e=t.prop,t.prop=t.opp,t.opp=e},t.editBallot=function(e){var n,r,i,a,l,u,c,h,f,m,g,v,y,b;if(c=t.$new(),n=d.ballots[e],null!=n.teams[0]&&null!=n.teams[1]){for(l=d.ballotsPerMatchSolved(),c.votes=n.getVotesForBallots(l),c.speakers=[n.teams[0].players,n.teams[1].players],a=c.votes.length,c.winner=function(t){return t.prop>t.opp?"prop":"opp"},c.roles=n.getSpeakerRoles(),c.presence=[n.presence[0],n.presence[1]],c.sides=["Prop","Opp"],c.sidesClass=["prop","opp"],c.validPlayer=function(t,e){var n,r,o;for(n=0,r=o=0;2>=o;r=++o)e[r]===t&&n++;return n},h=function(t){return[_.range((t/2>>0)+1,t+1),_.range((t/2>>0)+(1&t))]},l=0,m=function(t){var e,r;return r=c.votes[t],e=r.ballots,l+=e,r.judge||n.locked||(c.noJudgesWarning=!0),r.aux={decisionValid:!0,validSplits:h(e),winner:0},c.$watch(function(){return r.prop},function(){return r.opp=r.ballots-r.prop}),c.$watch(function(){return r.opp},function(){return r.prop=r.ballots-r.opp}),c.$watch(function(){return u(r)},function(t){var e,n;return r.aux.decisionValid=!0,r.prop>r.opp?(n=r.prop,e=r.opp):(n=r.opp,e=r.prop),0===t?(r.prop=n,r.opp=e,r.aux.winner=0):1===t?(r.prop=e,r.opp=n,r.aux.winner=1):r.aux.decisionValid=!1})},r=v=0;a>=0?a>v:v>a;r=a>=0?++v:--v)m(r);if(c.lockJudgesInfo=!n.locked&&!c.noJudgesWarning,a>1){for(c.votes.push(f={judge:{name:"Total"},scores:[[70,70,70,35],[70,70,70,35]],total:!0,aux:{decisionValid:!0,validSplits:h(l),winner:0}}),r=y=0;2>y;r=++y)for(g=function(t,e){return c.$watch(function(){var n,r,o,i,s;for(n=0,s=c.votes,i=0,o=s.length;o>i;i++)r=s[i],r.total||(n+=r.scores[t][e]*r.ballots);return n/l},function(n){return f.scores[t][e]=n})},i=b=0;4>b;i=++b)g(r,i);c.$watch(function(){var t,e,n,r,o;for(t=0,o=c.votes,r=0,n=o.length;n>r;r++)e=o[r],e.total||(t+=e.prop);return t},function(t){return f.prop=t}),c.$watch(function(){var t,e,n,r,o;for(t=0,o=c.votes,r=0,n=o.length;n>r;r++)e=o[r],e.total||(t+=e.opp);return t},function(t){return f.opp=t}),c.$watch(function(){var t,e;for(t=e=0;a>=0?a>e:e>a;t=a>=0?++e:--e)if(!c.votes[t].aux.decisionValid)return!1;return!0},function(t){return c.votes[a].aux.decisionValid=t})}return u=function(t){var e,n,r,o;return n=t.scores[0],e=t.scores[1],o=n[0]+n[1]+n[2]+n[3],r=e[0]+e[1]+e[2]+e[3],o>r?0:r>o?1:2},new o({buttons:["Cancel","Ok"],cancelButtonIndex:0,width:760,title:'<span class="prop">'+n.teams[0].name+'</span><span> vs. </span><span class="opp">'+n.teams[1].name+"</span>",htmlMessage:s(templates.ballotSheet())(c),animated:!1,onClick:function(e,o){var s,a,l,u,d,h,f,m,g,v,y,b;if(c.$apply(function(){return c.drawsError=!1,c.outOfRangeError=!1}),u=!1,a=c.presence[0]&&c.presence[1],1===o){for(y=c.votes,f=0,d=y.length;d>f;f++)if(l=y[f],!l.total){for(r=m=0;1>=m;r=++m){for(i=g=0;2>=g;i=++g)if(s=l.scores[r][i],(60>s||s>80)&&(u=!0,a))return c.$apply(function(){return c.outOfRangeError=!0}),void 0;if(s=l.scores[r][3],(30>s||s>40)&&(u=!0,a))return c.$apply(function(){return c.outOfRangeError=!0}),void 0}if(!l.aux.decisionValid&&(u=!0,a))return c.$apply(function(){return c.drawsError=!0}),void 0}for(u||(n.votes=_.filter(c.votes,function(t){return!t.total})),n.roles=[c.roles[0].roles,c.roles[1].roles],n.presence=[c.presence[0],c.presence[1]],c.$destroy(),c=null,b=n.votes,v=0,h=b.length;h>v;v++)l=b[v],delete l.aux;return n.locked=!0,t.$apply(function(){return p(n)}),e.modal("hide")}},onDismissed:function(){return null!=c?c.$destroy():void 0}})}}}]})}})}).call(this);
(function(){define(["team","judge","round","util","alertcontroller"],function(e,t,n,r,o){return function(e,i){return i.when("/rounds/:roundIndex",{templateUrl:"partials/rounds.html",controller:["$scope","$routeParams","$compile",function(e,i,a){var s,l,u,c,d,p,f,h,m,v,g,b,y,w,k,x,C,S,j;for(l=i.roundIndex-1,d=e.round=e.tournament.rounds[l],e.ranks=t.ranks,e.rankStrings=t.rankStrings,e.ballotsPerMatchOptions=[1,3,5,7,9],e.infinity=1e4,e.maxPanelChoices=[e.infinity,0,1,2,3,4,5,6,7,8,9],e.infinityName=function(e,t,n){return e===t?n:e},r.installScopeUtils(e),j=e.truncFloat,e.truncFloatN=function(e,t){return"number"==typeof e?j(e,t):e},x=d.judges,h=function(t){return e.$watch(function(){var e;return e=t.rounds[d.id],null!=e?e.participates:null},function(e,n){var o;null!=e&&e!==n&&(e?d.freeJudges.push(t):(o=t.rounds[d.id],null!=o&&o.ballot&&!o.ballot.locked?(o.shadow?r.arrayRemove(o.ballot.shadows,t):r.arrayRemove(o.ballot.judges,t),o.ballot=null):r.arrayRemove(d.freeJudges,t)))})},v=0,y=x.length;y>v;v++)u=x[v],h(u);for(C=d.rooms,m=function(t){return e.$watch(function(){var e;return e=t.rounds[d.id],null!=e?e.participates:null},function(e,n){var o;null!=e&&e!==n&&(e?d.freeRooms.push(t):(o=t.rounds[d.id],null!=o&&o.ballot?(o.ballot.room=null,o.ballot=null):r.arrayRemove(d.freeRooms,t)))})},g=0,w=C.length;w>g;g++)c=C[g],m(c);for(e.addAllTeams=function(){var t,n,r,o,i;for(o=e.tournament.teams,i=[],n=0,r=o.length;r>n;n++)t=o[n],i.push(t.rounds[d.id].participates=!0);return i},e.removeAllTeams=function(){var t,n,r,o,i;for(o=e.tournament.teams,i=[],n=0,r=o.length;r>n;n++)t=o[n],i.push(t.rounds[d.id].participates=!1);return i},e.addAllJudges=function(){var t,n,r,o,i;for(o=e.tournament.judges,i=[],n=0,r=o.length;r>n;n++)u=o[n],t=u.rounds[d.id],null!=t.ballot&&t.ballot.locked||i.push(t.participates=!0);return i},e.removeAllJudges=function(){var t,n,r,o,i;for(o=e.tournament.judges,i=[],n=0,r=o.length;r>n;n++)u=o[n],t=u.rounds[d.id],null!=t.ballot&&t.ballot.locked||i.push(t.participates=!1);return i},e.removeShadows=function(){var n,r,o,i,a;for(i=e.tournament.judges,a=[],r=0,o=i.length;o>r;r++)if(u=i[r],u.rank===t.shadowRank){if(n=u.rounds[d.id],null!=n.ballot&&n.ballot.locked)continue;a.push(n.participates=!1)}else a.push(void 0);return a},e.addAllRooms=function(){var t,n,r,o;for(r=e.tournament.rooms,o=[],t=0,n=r.length;n>t;t++)c=r[t],o.push(c.rounds[d.id].participates=!0);return o},e.removeAllRooms=function(){var t,n,r,o;for(r=e.tournament.rooms,o=[],t=0,n=r.length;n>t;t++)c=r[t],o.push(c.rounds[d.id].participates=!1);return o},e.sortByRank=function(){return d.sortByRank(d.teams)},e.shuffleRooms=function(){return d.shuffleRooms()},e.judgeUd=function(e,t){return{ballot:e,shadow:t}},e.judgeGroupTest=function(e,t){var n;return n=t.ud.ballot,null==n?!0:e===t?!0:!n.locked&&n.teams[0]&&n.teams[1]?t.ud.shadow||n.judges.length<d.ballotsPerMatchSolved():!1},e.judgeMove=function(e,t,n,r){var o,i;return e===n&&r>t&&r--,o=e.model.splice(t,1)[0],n.model.splice(r,0,o),i=o.rounds[d.id],i.ballot=n.ud.ballot,i.shadow=n.ud.shadow},p=function(t){var n,o,i,a,s,l,u,c,p,f,h,m,v,g,b,y;if(null==e.scoreDecimals&&(e.scoreDecimals=0),l=e.scoreDecimals,a=function(e){var t,n;return t=r.decimalsOf(e[0],2),n=r.decimalsOf(e[1],2),n>t?n:t},c=!0,u=!0,t&&(o=a(t),o===l?(c=!1,u=!1):o>l&&(e.scoreDecimals=l=o,u=!1)),u){for(i=0,g=d.ballots,f=0,m=g.length;m>f;f++)n=g[f],s=n.stats.rawScores,null!=s&&(o=a(s),o>i&&(i=o));l===i?c=!1:e.scoreDecimals=l=i}if(c){for(b=d.ballots,y=[],h=0,v=b.length;v>h;h++)n=b[h],p=n.stats,null!=p.rawScores&&y.push(p.scores=[p.rawScores[0].toFixed(l),p.rawScores[1].toFixed(l)]);return y}},f=function(t,n){var r,o,i,a,s,l,u,c,d,f,h,m,v,g;if(null==n&&(n=!0),a=null!=t.teams[0]&&t.presence[0],s=null!=t.teams[1]&&t.presence[1],a||s)if(a&&s)if(t.locked){for(l=[0,0],d=[0,0],u=f=0;1>=f;u=++f){for(r=0,g=t.votes,h=0,m=g.length;m>h;h++){for(c=g[h],i=v=0;4>v;i=++v)l[u]+=c.scores[u][i]*c.ballots;d[u]+=u?c.opp:c.prop,r+=c.ballots}l[u]/=r}o=e.scoreDecimals,t.stats={scores:[l[0].toFixed(o),l[1].toFixed(o)],rawScores:l,winClass:d[0]>d[1]?"prop":"opp",classes:["",""]},n&&p(l)}else t.stats={scores:["unfilled",""],winClass:"hidden-true",classes:["muted-true",""]};else t.stats={scores:["default win",""],winClass:"hidden-true",classes:[a?"prop":"opp","hidden-true"]};else t.stats={scores:["not played",""],winClass:"hidden-true",classes:["","hidden-true"]}},S=d.ballots,b=0,k=S.length;k>b;b++)s=S[b],f(s,!1);return p(),e.assignJudges=function(){return d.assignJudges()},e.assignRooms=function(){return d.assignRooms()},e.pair=function(){var t;return e.pairOpts={algorithm:0,shuffle:!1,balance:!0,brackets:1},t=e.prevRounds=d.previousRounds(),e.pairAlgorithms=t.length?n.allAlgos:n.initialAlgos,e.algoName=n.algoName,e.pairingTeams=d.pairingTeams(),e.manualPairing=[],new o({buttons:["Cancel","Ok"],cancelButtonIndex:0,title:"Round "+(l+1)+" pairing",htmlMessage:a(templates.pairModal())(e),onClick:function(t,n){var o;if(1===n){if(o=e.pairOpts,1===o.algorithm){if(e.pairingTeams.length)return t.find(".error-placeholder").html(templates.errorAlert({error:"You must pair all the teams before continuing"})),void 0;o.manualPairing=e.manualPairing}return t.modal("hide"),r.safeApply(e,function(){var e,t,n,r;for(d.pair(o),n=d.ballots,r=[],e=0,t=n.length;t>e;e++)s=n[e],r.push(f(s));return r})}}})},e.addTeamToManualPairing=function(t,n){var r,o;if(e.incompletePairing)if(o=e.incompletePairing,e.incompletePairing=null,o.prop){if(o.opp)return;o.opp=t}else o.prop=t;else o=e.incompletePairing={prop:t},e.manualPairing.push(o),r=$(".manual-pairings .span8"),r.animate({scrollTop:r[0].scrollHeight},500);return e.pairingTeams.splice(n,1)},e.removePairFromManualPairing=function(t,n){return t.prop?t.opp?e.pairingTeams.splice(0,0,t.prop,t.opp):e.pairingTeams.splice(0,0,t.prop):e.pairingTeams.splice(0,0,t.opp),e.manualPairing.splice(n,1),t===e.incompletePairing?e.incompletePairing=null:void 0},e.reverseSidesInManualPairing=function(e){var t;return t=e.prop,e.prop=e.opp,e.opp=t},e.editBallot=function(t){var n,r,i,s,l,u,c,p,h,m,v,g,b,y;if(c=e.$new(),n=d.ballots[t],null!=n.teams[0]&&null!=n.teams[1]){for(l=d.ballotsPerMatchSolved(),c.votes=n.getVotesForBallots(l),c.speakers=[n.teams[0].players,n.teams[1].players],s=c.votes.length,c.winner=function(e){return e.prop>e.opp?"prop":"opp"},c.roles=n.getSpeakerRoles(),c.presence=[n.presence[0],n.presence[1]],c.sides=["Prop","Opp"],c.sidesClass=["prop","opp"],c.validPlayer=function(e,t){var n,r,o;for(n=0,r=o=0;2>=o;r=++o)t[r]===e&&n++;return n},p=function(e){return[_.range((e/2>>0)+1,e+1),_.range((e/2>>0)+(1&e))]},l=0,m=function(e){var t,r;return r=c.votes[e],t=r.ballots,l+=t,r.judge||n.locked||(c.noJudgesWarning=!0),r.aux={decisionValid:!0,validSplits:p(t),winner:0},c.$watch(function(){return r.prop},function(){return r.opp=r.ballots-r.prop}),c.$watch(function(){return r.opp},function(){return r.prop=r.ballots-r.opp}),c.$watch(function(){return u(r)},function(e){var t,n;return r.aux.decisionValid=!0,r.prop>r.opp?(n=r.prop,t=r.opp):(n=r.opp,t=r.prop),0===e?(r.prop=n,r.opp=t,r.aux.winner=0):1===e?(r.prop=t,r.opp=n,r.aux.winner=1):r.aux.decisionValid=!1})},r=g=0;s>=0?s>g:g>s;r=s>=0?++g:--g)m(r);if(c.lockJudgesInfo=!n.locked&&!c.noJudgesWarning,s>1){for(c.votes.push(h={judge:{name:"Total"},scores:[[70,70,70,35],[70,70,70,35]],total:!0,aux:{decisionValid:!0,validSplits:p(l),winner:0}}),r=b=0;2>b;r=++b)for(v=function(e,t){return c.$watch(function(){var n,r,o,i,a;for(n=0,a=c.votes,i=0,o=a.length;o>i;i++)r=a[i],r.total||(n+=r.scores[e][t]*r.ballots);return n/l},function(n){return h.scores[e][t]=n})},i=y=0;4>y;i=++y)v(r,i);c.$watch(function(){var e,t,n,r,o;for(e=0,o=c.votes,r=0,n=o.length;n>r;r++)t=o[r],t.total||(e+=t.prop);return e},function(e){return h.prop=e}),c.$watch(function(){var e,t,n,r,o;for(e=0,o=c.votes,r=0,n=o.length;n>r;r++)t=o[r],t.total||(e+=t.opp);return e},function(e){return h.opp=e}),c.$watch(function(){var e,t;for(e=t=0;s>=0?s>t:t>s;e=s>=0?++t:--t)if(!c.votes[e].aux.decisionValid)return!1;return!0},function(e){return c.votes[s].aux.decisionValid=e})}return u=function(e){var t,n,r,o;return n=e.scores[0],t=e.scores[1],o=n[0]+n[1]+n[2]+n[3],r=t[0]+t[1]+t[2]+t[3],o>r?0:r>o?1:2},new o({buttons:["Cancel","Ok"],cancelButtonIndex:0,width:700,title:'<span class="prop">'+n.teams[0].name+'</span><span> vs. </span><span class="opp">'+n.teams[1].name+"</span>",htmlMessage:a(templates.ballotSheet())(c),onClick:function(t,o){var a,s,l,u,d,p,h,m,v,g,b,y;if(c.$apply(function(){return c.drawsError=!1,c.outOfRangeError=!1}),u=!1,s=c.presence[0]&&c.presence[1],1===o){for(b=c.votes,h=0,d=b.length;d>h;h++)if(l=b[h],!l.total){for(r=m=0;1>=m;r=++m){for(i=v=0;2>=v;i=++v)if(a=l.scores[r][i],(60>a||a>80)&&(u=!0,s))return c.$apply(function(){return c.outOfRangeError=!0}),void 0;if(a=l.scores[r][3],(30>a||a>40)&&(u=!0,s))return c.$apply(function(){return c.outOfRangeError=!0}),void 0}if(!l.aux.decisionValid&&(u=!0,s))return c.$apply(function(){return c.drawsError=!0}),void 0}for(u||(n.votes=_.filter(c.votes,function(e){return!e.total})),n.roles=[c.roles[0].roles,c.roles[1].roles],n.presence=[c.presence[0],c.presence[1]],c.$destroy(),c=null,y=n.votes,g=0,p=y.length;p>g;g++)l=y[g],delete l.aux;return n.locked=!0,e.$apply(function(){return f(n)}),t.modal("hide")}},onDismissed:function(){return null!=c?c.$destroy():void 0}})}}}]})}})}).call(this);
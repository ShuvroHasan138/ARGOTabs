(function(){define(["jquery","B64","cookies","opencontroller","alertcontroller","tournament","backends","localbackend","routes/routes","util","round","components","editable-table","angular-route"],function(a,b,c,d,e,f,g,h,i,j,k){var l;return l=function(){function l(){var b,c=this;this.app=b=angular.module("argotabs",["components","editable-table","ngRoute"]),b.controller("LoadingCtrl",["$scope",function(a){return a.loaded=!0}]),b.controller("RoutesList",["$scope","$location",function(a,b){return a.addRound=function(){var a;return a=c.tournament,a.rounds.push(new k(a))},a.removeRound=function(d){return new e({buttons:["Cancel","Delete"],cancelButtonIndex:0,primaryButtonIndex:1,title:"Delete Round "+(d+1),width:400,htmlMessage:"<p>Are you sure you want to delete Round "+(d+1)+"?</p><p>This will remove the pairing, all ballots and all scores associated with this round. Most mistakes can be corrected without deleting the whole round.</p>",onClick:function(e,f,g){if(f===1)return a.$apply(function(){var a,f;return b.path().match(/^\/round/)&&b.path("/"),f=c.tournament,a=f.rounds[d],f.rounds.splice(d,1),a.destroy(),e.modal("hide")})}})}}]),i(this),this.injector=angular.bootstrap(document,["argotabs"]),a(document).ready(function(){return c.loadSession(function(){return new d(c)}),a(".fixed-menu").mouseover(function(){var b,c,d,e;return d=a(this).offset().left+325,e=a(window).width(),c=a(this).offset().left+a(this).width(),b=a(this).offset().left-a(this).width(),a(this).find("ul").offset({left:d>e?b:c})}),a(".action-open").click(function(){return c.open()}),a(".action-download").click(function(){return c.download()}),a(".action-saveaslocal").click(function(){return c.saveaslocal()}),a(".action-save").click(function(){return c.save()})}),this.autosaveStopped=0,setInterval(function(){if(!c.autosaveStopped)return c.save(function(){},!0)},5e3)}return l.prototype.open=function(){var a=this;return this.save(function(){return new d(a)})},l.prototype.loadSession=function(a){var b,d,e,h,i,k,l,m=this;h=c.get("lastBackend"),i=c.get("lastFileName"),e=!1;if(h&&i)for(k=0,l=g.length;k<l;k++){b=g[k];if(j.getClass(b)===h){try{b.listFiles(function(a){if(a.indexOf(i)!==-1)return m.setTournament(new f(new b(i))),e=!0})}catch(n){d=n,console.log(d.message)}break}}if(!e)return a()},l.prototype.save=function(b,c){var d,f,g,h,i=this;c==null&&(c=!1),b==null&&(b=function(){});if(!this.tournament)return b();d=a(".action-save"),f=a(".view-save"),d.button("loading"),clearTimeout(this._saveTimer),this.autosaveStopped++;try{g=function(){return i.autosaveStopped--,d.button("saved"),f.addClass("btn-success"),f.removeClass("btn-info"),i._saveTimer=setTimeout(function(){return d.button("reset"),f.addClass("btn-info"),f.removeClass("btn-success")},1e3),b()};if(!c)return this.tournament.save(g);if(!this.tournament.saveIfRequired(g))return this.autosaveStopped--,d.button("reset")}catch(j){return h=j,new e({title:"Saving error",message:h.message,buttons:h.canForce?[h.canForce,"OK"]:["OK"],cancelButtonIndex:h.canForce?1:0,onClick:function(a,c){var d,e;if(h.canForce&&c===0){d=a.find(".modal-footer").children().first(),d[0].dataset.loading-(e="Saving..."),d.button("loading");try{return i.tournament.save(function(){return a.modal("hide"),b()},!0)}catch(f){return h=f,h.canForce?(d.show(),d.html(h.canForce)):d.hide(),d.button("reset"),a.find(".modal-body").html("<p>"+h.message+"</p>")}}},onDismissed:function(){return d.button("reset"),i.autosaveStopped--}})}},l.prototype.download=function(){var c,d;if(!this.tournament)return;return c=b.encode(this.tournament.toFile()),a("body").append('<a id="downloader" download="'+this.tournament.name+'.atab" href="data:application/octet-stream;base64,'+c+'"></a>'),d=a("#downloader"),d[0].click(),d.remove()},l.prototype.saveaslocal=function(){var a,b=this;return a={},h.listFiles(function(b){var c,d,e,f;f=[];for(d=0,e=b.length;d<e;d++)c=b[d],f.push(a[c]=!0);return f}),new e({title:"Save as",htmlMessage:templates.saveAs({value:this.tournament.backend.fileName()+" (2)"}),buttons:["Cancel","Save"],cancelButtonIndex:0,width:400,onShow:function(b){var c,d;return d=b.find(".saveas-text"),c=b.find(".saveas-control-group"),d.bind("input propertychange",function(){var b;return b=d[0].value,a[b]?c.addClass("error"):c.removeClass("error")}),a[d[0].value]&&c.addClass("error"),d.keypress(function(a){if(a.which===13)return b.find(".btn-primary").click()})},onShown:function(a){var b;return b=a.find(".saveas-text"),b.focus()},onClick:function(c,d,e,f){var g,i,j,k,l,m,n;f==null&&(f=!1);if(d===1){n=arguments.callee,l=c.find(".saveas-text")[0].value;if(!a[l]){f||c.find(".btn-primary").button("loading");try{return g=new h(l),j=b.tournament.toFile,g.save(j,function(){return c.modal("hide")},f)}catch(o){k=o,c.find(".btn-primary").button("reset"),c.find(".saveas-error").remove(),c.find(".modal-body").append(templates.alert({classes:"saveas-error alert-error"+(k.canForce?" alert-block":void 0),title:"Error while saving file:",message:k.message,button:k.canForce,buttonClass:"btn-danger"}));if(k.canForce)return i=c.find(".btn-danger"),i[0].dataset.loading-(m="Saving..."),i.click(function(){return i.button("loading"),n(c,d,null,!0)})}}}}})},l.prototype.getTournament=function(){return this.tournament},l.prototype.setTournament=function(a){var b=this;return this.tournament=a,a?a.load(function(){return c.set("lastBackend",j.getObjectClass(a.backend)),c.set("lastFileName",a.backend.fileName()),b.injector.invoke(["$rootScope",function(b){return b.$apply(function(){return b.tournament=a})}])}):(c.expire("lastBackend"),c.expire("lastFileName"),this.injector.invoke(["$rootScope",function(a){return a.$apply(function(){return a.tournament=nil})}]))},l}()})}).call(this)
(function(){define(["jquery","B64","cookies","opencontroller","alertcontroller","tournament","backends","localbackend","routes/routes","util","round","components","editable-table","angular"],function(t,e,n,r,o,i,s,a,l,u,d){var c;return c=function(){function c(){var e,n=this;this.app=e=angular.module("argotabs",["components","editable-table"]),e.controller("LoadingCtrl",["$scope",function(t){return t.loaded=!0}]),e.controller("RoutesList",["$scope","$location",function(t,e){return t.addRound=function(){var t;return t=n.tournament,t.rounds.push(new d(t))},t.removeRound=function(r){return new o({buttons:["Cancel","Delete"],cancelButtonIndex:0,primaryButtonIndex:1,title:"Delete Round "+(r+1),width:400,htmlMessage:"<p>Are you sure you want to delete Round "+(r+1)+"?</p><p>This will remove the pairing, all ballots and all scores associated with this round. Most mistakes can be corrected without deleting the whole round.</p>",onClick:function(o,i){return 1===i?t.$apply(function(){var t,i;return e.path().match(/^\/round/)&&e.path("/"),i=n.tournament,t=i.rounds[r],i.rounds.splice(r,1),t.destroy(),o.modal("hide")}):void 0}})}}]),l(this),this.injector=angular.bootstrap(document,["argotabs"]),t(document).ready(function(){return n.loadSession(function(){return new r(n)}),t(".fixed-menu").mouseover(function(){var e,n,r,o;return r=t(this).offset().left+325,o=t(window).width(),n=t(this).offset().left+t(this).width(),e=t(this).offset().left-t(this).width(),t(this).find("ul").offset({left:r>o?e:n})}),t(".action-open").click(function(){return n.open()}),t(".action-download").click(function(){return n.download()}),t(".action-saveaslocal").click(function(){return n.saveaslocal()}),t(".action-save").click(function(){return n.save()})}),this.autosaveStopped=0,setInterval(function(){return n.autosaveStopped?void 0:n.save(function(){},!0)},5e3)}return c.prototype.open=function(){var t=this;return this.save(function(){return new r(t)})},c.prototype.loadSession=function(t){var e,r,o,a,l,d,c,h=this;if(a=n.get("lastBackend"),l=n.get("lastFileName"),o=!1,a&&l)for(d=0,c=s.length;c>d;d++)if(e=s[d],u.getClass(e)===a){try{e.listFiles(function(t){return-1!==t.indexOf(l)?(h.setTournament(new i(new e(l))),o=!0):void 0})}catch(f){r=f,console.log(r.message)}break}return o?void 0:t()},c.prototype.save=function(e,n){var r,i,s,a,l=this;if(null==n&&(n=!1),null==e&&(e=function(){}),!this.tournament)return e();r=t(".action-save"),i=t(".view-save"),r.button("loading"),clearTimeout(this._saveTimer),this.autosaveStopped++;try{if(s=function(){return l.autosaveStopped--,r.button("saved"),i.addClass("btn-success"),i.removeClass("btn-info"),l._saveTimer=setTimeout(function(){return r.button("reset"),i.addClass("btn-info"),i.removeClass("btn-success")},1e3),e()},!n)return this.tournament.save(s);if(!this.tournament.saveIfRequired(s))return this.autosaveStopped--,r.button("reset")}catch(u){return a=u,new o({title:"Saving error",message:a.message,buttons:a.canForce?[a.canForce,"OK"]:["OK"],cancelButtonIndex:a.canForce?1:0,onClick:function(t,n){var r,o;if(a.canForce&&0===n){r=t.find(".modal-footer").children().first(),r[0].dataset.loading-(o="Saving..."),r.button("loading");try{return l.tournament.save(function(){return t.modal("hide"),e()},!0)}catch(i){return a=i,a.canForce?(r.show(),r.html(a.canForce)):r.hide(),r.button("reset"),t.find(".modal-body").html("<p>"+a.message+"</p>")}}},onDismissed:function(){return r.button("reset"),l.autosaveStopped--}})}},c.prototype.download=function(){var n,r;if(this.tournament)return n=e.encode(this.tournament.toFile()),t("body").append('<a id="downloader" download="'+this.tournament.name+'.atab" href="data:application/octet-stream;base64,'+n+'"></a>'),r=t("#downloader"),r[0].click(),r.remove()},c.prototype.saveaslocal=function(){var t,e=this;return t={},a.listFiles(function(e){var n,r,o,i;for(i=[],r=0,o=e.length;o>r;r++)n=e[r],i.push(t[n]=!0);return i}),new o({title:"Save as",htmlMessage:templates.saveAs({value:this.tournament.backend.fileName()+" (2)"}),buttons:["Cancel","Save"],cancelButtonIndex:0,width:400,onShow:function(e){var n,r;return r=e.find(".saveas-text"),n=e.find(".saveas-control-group"),r.bind("input propertychange",function(){var e;return e=r[0].value,t[e]?n.addClass("error"):n.removeClass("error")}),t[r[0].value]&&n.addClass("error"),r.keypress(function(t){return 13===t.which?e.find(".btn-primary").click():void 0})},onShown:function(t){var e;return e=t.find(".saveas-text"),e.focus()},onClick:function(n,r,o,i){var s,l,u,d,c,h,f;if(null==i&&(i=!1),1===r&&(f=arguments.callee,c=n.find(".saveas-text")[0].value,!t[c])){i||n.find(".btn-primary").button("loading");try{return s=new a(c),u=e.tournament.toFile,s.save(u,function(){return n.modal("hide")},i)}catch(p){if(d=p,n.find(".btn-primary").button("reset"),n.find(".saveas-error").remove(),n.find(".modal-body").append(templates.alert({classes:"saveas-error alert-error"+(d.canForce?" alert-block":void 0),title:"Error while saving file:",message:d.message,button:d.canForce,buttonClass:"btn-danger"})),d.canForce)return l=n.find(".btn-danger"),l[0].dataset.loading-(h="Saving..."),l.click(function(){return l.button("loading"),f(n,r,null,!0)})}}}})},c.prototype.getTournament=function(){return this.tournament},c.prototype.setTournament=function(t){var e=this;return this.tournament=t,t?t.load(function(){return n.set("lastBackend",u.getObjectClass(t.backend)),n.set("lastFileName",t.backend.fileName()),e.injector.invoke(["$rootScope",function(e){return e.$apply(function(){return e.tournament=t})}])}):(n.expire("lastBackend"),n.expire("lastFileName"),this.injector.invoke(["$rootScope",function(t){return t.$apply(function(){return t.tournament=nil})}]))},c}()})}).call(this);
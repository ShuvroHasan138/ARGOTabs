!function(){define(["util","ballot","judge","sorter","team","underscore"],function(t,e,n,r,o){var i;return i=function(){function i(t,n){var o,i,s,a,l,u,d,c,h,f,p,m,v,g,b,y,w,k,x;if(this.tournament=t,n)for(a in n)d=n[a],this[a]=d;if(null==this.id&&(this.id=Math.floor(1e8*Math.random())),null==this.tableOpts&&(this.tableOpts={}),null==this.judges&&(this.judges=[]),null==this.teams&&(this.teams=[]),null==this.rooms&&(this.rooms=[]),null==this.ballots&&(this.ballots=[]),null==this.ballotsPerMatch&&(this.ballotsPerMatch=null),null==this.maxMainJudges&&(this.maxMainJudges=null),null==this.maxShadowJudges&&(this.maxShadowJudges=null),null==this.maxPanelSize&&(this.maxPanelSize=null),null==this.inheritPairRank&&(this.inheritPairRank=!0),this.pairRankSorter=r.teamRankSorter(this.pairRankSorter),null==this.rankFrom&&(this.rankFrom={all:!0}),n)for(y=this.ballots,i=c=0,m=y.length;m>c;i=++c)o=y[i],this.ballots[i]=new e(this,o);else{for(w=this.tournament.teams,h=0,v=w.length;v>h;h++)u=w[h],this.registerTeam(u);for(k=this.tournament.judges,f=0,g=k.length;g>f;f++)s=k[f],this.registerJudge(s);for(x=this.tournament.rooms,p=0,b=x.length;b>p;p++)l=x[p],this.registerRoom(l)}}return i.prototype.ballotsPerMatchSolved=function(){return null!=this.ballotsPerMatch?this.ballotsPerMatch:this.tournament.ballotsPerMatch},i.prototype.maxMainJudgesSolved=function(){return null!=this.maxMainJudges?this.maxMainJudges:this.tournament.maxMainJudges},i.prototype.maxShadowJudgesSolved=function(){return null!=this.maxShadowJudges?this.maxShadowJudges:this.tournament.maxShadowJudges},i.prototype.maxPanelSizeSolved=function(){return null!=this.maxPanelSize?this.maxPanelSize:this.tournament.maxPanelSize},i.prototype.pairRankSorterSolved=function(){return null!=this.pairRankSorter?this.pairRankSorter:this.tournament.pairRankSorter},i.prototype.unpackCycles=function(){var e,n,r,o,i;for(t.unpackCycles(this.teams,this.tournament.teams),t.unpackCycles(this.judges,this.tournament.judges),t.unpackCycles(this.rooms,this.tournament.rooms),o=this.ballots,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.unpackCycles());return i},i.prototype.previousRounds=function(){var t,e,n,r,o,i,s,a;if(t=[],this.rankFrom.all)for(s=this.tournament.rounds,n=0,o=s.length;o>n&&(e=s[n],e!==this);n++)e.paired&&t.push(e);else for(a=this.tournament.rounds,r=0,i=a.length;i>r;r++)e=a[r],e.paired&&this.rankFrom[e.id]&&t.push(e);return t},i.prototype.registerJudge=function(t){var e;return e=this.id,null==t.rounds[e]?(t.rounds[e]={participates:!0,locked:!1},this.judges.push(t)):void 0},i.prototype.unregisterJudge=function(t){var e;return e=this.judges.indexOf(t),-1!==e?this.judges.splice(e,1):void 0},i.prototype.registerTeam=function(t){var e;return e=this.id,null==t.rounds[e]?(t.rounds[e]={participates:!0,locked:!1},this.teams.push(t)):void 0},i.prototype.unregisterTeam=function(t){var e;return e=this.teams.indexOf(t),-1!==e?this.teams.splice(e,1):void 0},i.prototype.registerRoom=function(t){var e;return e=this.id,null==t.rounds[e]?(t.rounds[e]={participates:!0,locked:!1},this.rooms.push(t)):void 0},i.prototype.unregisterRoom=function(t){var e;return e=this.rooms.indexOf(t),-1!==e?this.rooms.splice(e,1):void 0},i.prototype.sortByRank=function(t){var e;return o.calculateStats(t,this.previousRounds()),e=this.pairRankSorterSolved().compareObjects,t.sort(function(t,n){return e(t.stats,n.stats)})},i.prototype.pairingTeams=function(){var t,e;return t=this.id,e=_.filter(this.teams,function(e){return e.rounds[t].participates})},i.prototype.pair=function(t){var n,r,o,i,s,a,l,u,d,c,h,f,p,m,v,g,b,y,w=this;switch(h=this.pairingTeams(),t.algorithm?this.sortByRank(h):h=_.shuffle(h),1&h.length&&h.push(null),i=this.id,l=_.filter(this.rooms,function(t){return t.rounds[i].participates}),u=0,d=l.length,r=t.shuffleSides||1!==t.algorithm,n=t.balanceSides,null==n&&(n=!0),a=function(t,n,o){var s,a,c;return null==o&&(o=0),a=new e(w),a.teams[0]=t,a.teams[1]=n,a.skillIndex=o,null==t||null==n?(null==t&&(s=t,t=n,n=s,a.teams[0]=t,a.teams[1]=n),a.locked=!0):r&&(c=.5,Math.random()>c&&(a.teams[0]=n,a.teams[1]=t)),d>u&&(a.room=l[u]),u++,w.ballots.push(a),null!=t&&(t.rounds[i].ballot=a),null!=n?n.rounds[i].ballot=a:void 0},c=0,t.algorithm){case 0:for(o=f=0,g=h.length;g>f;o=f+=2)a(h[o],h[o+1]);break;case 1:for(b=t.manualPairing,p=0,v=b.length;v>p;p++)s=b[p],a(s.prop,s.opp);break;case 3:for(o=m=0,y=h.length;y>m;o=m+=2)a(h[o],h[o+1],c++)}return this.paired=!0,t.shuffleRooms&&this.shuffleRooms(),this.assignJudges()},i.prototype.assignJudges=function(){var t,e,r,o,i,s,a,l,u,d,c,h,f,p,m,v,g,b,y,w,k,x,C,j,I;for(s=this.id,u=_.shuffle(_.filter(this.judges,function(t){return t.rounds[s].participates&&t.rank!==n.shadowRank})),u.sort(function(t,e){return t.rank<e.rank}),v=_.shuffle(_.filter(this.judges,function(t){return t.rounds[s].participates&&t.rank===n.shadowRank})),o=_.sortBy(_.shuffle(_.filter(this.ballots,function(t){return t.teams[0]&&t.teams[1]},function(t){return t.skillIndex}))),b=0,x=o.length;x>b;b++)t=o[b],t.judges=[],t.shadows=[];if(h=o.length,f=u.length,h>f){for(g=h-f,v.length<g&&(g=v.length),i=y=0;g>=0?g>y:y>g;i=g>=0?++y:--y)u.push(v[i]);v.splice(0,g)}for(r=this.ballotsPerMatchSolved(),p=this.maxPanelSizeSolved(),c=this.maxShadowJudgesSolved(),d=this.maxMainJudgesSolved(),i=0,w=0,C=u.length;C>w;w++)a=u[w],e=o[i],l=e.judges.length,m=e.shadows.length,l+m>=p||(r>l&&d>l?e.judges.push(a):c>m&&e.shadows.push(a),++i>=h&&(i=0));for(I=[],k=0,j=v.length;j>k;k++)a=v[k],e=o[i],l=e.judges.length,m=e.shadows.length,p>l+m&&c>m&&e.shadows.push(a),++i>=h?I.push(i=0):I.push(void 0);return I},i.prototype.shuffleRooms=function(){var t,e,n,r,o,i,s;for(e=_.shuffle(this.ballots),r=_.map(this.ballots,function(t){return t.room}),s=[],n=o=0,i=e.length;i>o;n=++o)t=e[n],t.room=r[n],s.push(this.ballots[n]=t);return s},i.prototype.toJSON=function(){var e;return e=t.copyObject(this,["tournament"]),e.teams=t.packCycles(this.teams,this.tournament.teams),e.judges=t.packCycles(this.judges,this.tournament.judges),e.rooms=t.packCycles(this.rooms,this.tournament.rooms),e},i.prototype.destroy=function(){var t,e,n,r,o,i,s,a,l,u,d,c,h,f;for(t=this.id,d=this.tournament.teams,o=0,a=d.length;a>o;o++)r=d[o],delete r.rounds[t];for(c=this.tournament.judges,i=0,l=c.length;l>i;i++)e=c[i],delete e.rounds[t];for(h=this.tournament.rooms,f=[],s=0,u=h.length;u>s;s++)n=h[s],f.push(delete n.rounds[t]);return f},i.allAlgos=[0,1,2,3],i.initialAlgos=[0,1],i.algoName=["Random","Manual","High-Low","Power Pairing"],i}()})}.call(this);
(function(){define(["util","ballot","judge","sorter","judgerules","team","underscore"],function(t,e,n,r,o,i){var s;return s=function(){function s(t,n){var i,s,a,l,u,d,c,h,f,p,m,g,v,b,y,w,k,C,x;if(this.tournament=t,n)for(l in n)c=n[l],this[l]=c;if(null==this.id&&(this.id=Math.floor(1e8*Math.random())),null==this.tableOpts&&(this.tableOpts={}),null==this.teams&&(this.teams=[]),null==this.judges&&(this.judges=[]),null==this.freeJudges&&(this.freeJudges=[]),null==this.rooms&&(this.rooms=[]),null==this.freeRooms&&(this.freeRooms=[]),null==this.ballots&&(this.ballots=[]),null==this.ballotsPerMatch&&(this.ballotsPerMatch=null),null==this.maxMainJudges&&(this.maxMainJudges=null),null==this.maxShadowJudges&&(this.maxShadowJudges=null),null==this.maxPanelSize&&(this.maxPanelSize=null),null==this.inheritPairRank&&(this.inheritPairRank=!0),null==this.allowShadows&&(this.allowShadows=null),null==this.judgeMainPriority&&(this.judgeMainPriority=null),null==this.judgeMainOrder&&(this.judgeMainOrder=null),null==this.judgeShadowPriority&&(this.judgeShadowPriority=null),null==this.judgeShadowOrder&&(this.judgeShadowOrder=null),null==this.judgeShadowReport&&(this.judgeShadowReport=null),this.pairRankSorter=r.teamRankSorter(this.pairRankSorter),this.judgeRules=new o(this.tournament,this.judgeRules),null==this.rankFrom&&(this.rankFrom={all:!0}),n)for(w=this.ballots,s=h=0,g=w.length;g>h;s=++h)i=w[s],this.ballots[s]=new e(this,i);else{for(k=this.tournament.teams,f=0,v=k.length;v>f;f++)d=k[f],this.registerTeam(d);for(C=this.tournament.judges,p=0,b=C.length;b>p;p++)a=C[p],this.registerJudge(a),a.rounds[this.id].participates=!0,this.freeJudges.push(a);for(x=this.tournament.rooms,m=0,y=x.length;y>m;m++)u=x[m],this.registerRoom(u)}}return s.prototype.ballotsPerMatchSolved=function(){return null!=this.ballotsPerMatch?this.ballotsPerMatch:this.tournament.ballotsPerMatch},s.prototype.maxMainJudgesSolved=function(){return null!=this.maxMainJudges?this.maxMainJudges:this.tournament.maxMainJudges},s.prototype.maxShadowJudgesSolved=function(){return null!=this.maxShadowJudges?this.maxShadowJudges:this.tournament.maxShadowJudges},s.prototype.maxPanelSizeSolved=function(){return null!=this.maxPanelSize?this.maxPanelSize:this.tournament.maxPanelSize},s.prototype.pairRankSorterSolved=function(){return null!=this.pairRankSorter?this.pairRankSorter:this.tournament.pairRankSorter},s.prototype.allowShadowsSolved=function(){return null!=this.allowShadows?this.allowShadows:this.tournament.allowShadows},s.prototype.judgeMainPrioritySolved=function(){return null!=this.judgeMainPriority?this.judgeMainPriority:this.tournament.judgeMainPriority},s.prototype.judgeMainOrderSolved=function(){return null!=this.judgeMainOrder?this.judgeMainOrder:this.tournament.judgeMainOrder},s.prototype.judgeShadowPrioritySolved=function(){return null!=this.judgeShadowPriority?this.judgeShadowPriority:this.tournament.judgeShadowPriority},s.prototype.judgeShadowOrderSolved=function(){return null!=this.judgeShadowOrder?this.judgeShadowOrder:this.tournament.judgeShadowOrder},s.prototype.judgeShadowReportSolved=function(){return null!=this.judgeShadowReport?this.judgeShadowReport:this.tournament.judgeShadowReport},s.prototype.getName=function(){var t;return t=this.tournament.rounds.indexOf(this),-1!==t?"Round "+(t+1):"<undefined>"},s.prototype.unpackCycles=function(){var e,n,r,o,i;for(t.unpackCycles(this.teams,this.tournament.teams),t.unpackCycles(this.judges,this.tournament.judges),t.unpackCycles(this.freeJudges,this.tournament.judges),t.unpackCycles(this.rooms,this.tournament.rooms),t.unpackCycles(this.freeRooms,this.tournament.rooms),o=this.ballots,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(e.unpackCycles());return i},s.prototype.previousRounds=function(){var t,e,n,r,o,i,s,a;if(t=[],this.rankFrom.all)for(s=this.tournament.rounds,n=0,o=s.length;o>n&&(e=s[n],e!==this);n++)e.paired&&t.push(e);else for(a=this.tournament.rounds,r=0,i=a.length;i>r;r++)e=a[r],e.paired&&this.rankFrom[e.id]&&t.push(e);return t},s.prototype.registerJudge=function(t){var e;return e=this.id,null==t.rounds[e]?(t.rounds[e]={participates:!1},this.judges.push(t)):void 0},s.prototype.unregisterJudge=function(e){var n;return n=e.rounds[this.id],null!=n&&null!=n.ballot&&(n.shadow?t.arrayRemove(n.ballot.shadows,e):t.arrayRemove(n.ballot.judges,e)),t.arrayRemove(this.judges,e),t.arrayRemove(this.freeJudges,e)},s.prototype.registerTeam=function(t){var e;return e=this.id,null==t.rounds[e]?(t.rounds[e]={participates:!0},this.teams.push(t)):void 0},s.prototype.unregisterTeam=function(e){return t.arrayRemove(this.teams,e)},s.prototype.registerRoom=function(t){var e;return e=this.id,null==t.rounds[e]?(t.rounds[e]={participates:!0},this.rooms.push(t),this.freeRooms.push(t)):void 0},s.prototype.unregisterRoom=function(e){var n;return n=e.rounds[this.id],null!=n&&null!=n.ballot&&(n.ballot.room=null),t.arrayRemove(this.rooms,e),t.arrayRemove(this.freeRooms,e)},s.prototype.sortByRank=function(t,e){var n;return null==e&&(e=this.previousRounds()),i.calculateStats(t,e),n=this.pairRankSorterSolved().boundComparator(),t.sort(function(t,e){return n(t.stats,e.stats)})},s.prototype.sortBallots=function(){return this.ballots.sort(function(t,e){return t.skillIndex-e.skillIndex})},s.prototype.pairingTeams=function(){var t,e;return t=this.id,e=_.filter(this.teams,function(e){return e.rounds[t].participates})},s.prototype.pair=function(t){var n,r,o,i,s,a,l,u,d,c,h,f,p,m,g,v,b,y,w,k,C,x,j,S,R,I,M,A,T,E,O,P,$,N,q,J,H,B,L,D,W,F,X,G,z,Y,U,V,K,Q,Z,te,ee,ne,re,oe,ie,se,ae,le,ue,de,ce,he,fe,pe,me,ge,ve,be=this;if(D=this.pairingTeams(),A=this.previousRounds(),this.sortByRank(D,A),g=this.id,p=!t.manualSides||1!==t.algorithm,o=t.balanceSides,null==o&&(o=!0),M=function(n,r,o){var i,s,a,l,u,d;return null==o&&(o=0),s=new e(be),s.teams[0]=n,s.teams[1]=r,s.skillIndex=o,null==n||null==r?(null==n&&(i=n,n=r,r=i,s.teams[0]=n,s.teams[1]=r),s.locked=!0):p&&(u=n.stats.side,d=r.stats.side,u===d&&1===t.sides&&(a=Math.abs(n.stats.prop-n.stats.opp),l=Math.abs(r.stats.prop-r.stats.opp),a>l?d=1-d:l>a&&(u=1-u)),u===d?Math.random()>.5&&(s.teams[0]=r,s.teams[1]=n):(1===u||0===d)&&(s.teams[0]=r,s.teams[1]=n)),be.ballots.push(s),n&&(n.rounds[g].ballot=s,n.stats.paired=!0),r?(r.rounds[g].ballot=s,r.stats.paired=!0):void 0},h=null,1&D.length&&1!==t.algorithm)if(t.algorithm||!t.randomBye&&A.length){for(w=Number.MAX_VALUE,v=-1,m=X=he=D.length-1;0>=he?0>=X:X>=0;m=0>=he?++X:--X){for(J=D[m],C=0,G=0,U=A.length;U>G;G++){N=A[G];try{J.rounds[N.id].ballot.teams[1]||C++}catch(ye){}}w>C&&(h=J,v=m,w=C)}D.splice(v,1)}else h=D.splice(Math.floor(Math.random()*D.length),1);if(1===t.sides)for(z=0,V=D.length;V>z;z++)L=D[z],T=L.stats.prop,I=L.stats.opp,I>T?L.stats.side=0:T>I&&(L.stats.side=1);else if("object"==typeof t.sides)for(P=t.sides.roundId,f=t.sides.flip,Y=0,Q=D.length;Q>Y;Y++)L=D[Y],i=L.rounds[P].ballot,null!=i&&null!=i.teams[1]&&(L.stats.side=i.teams[1]===L^f);switch(0===t.algorithm&&(D=_.shuffle(D)),O={conditions:[],match:function(t,e){var n,r,o,i,s,a,l,u,d;for(l=this.conditions,i=l.length,o=new Array(i),a=new Array(i),r=d=0,u=l.length;u>d;r=++d)n=l[r],o[r]=Number.MAX_VALUE;return s=null,e(function(e){var n,r,i,u,d,c,h;if(!e.stats.paired){for(r=0,d=!0,u=h=0,c=l.length;c>h;u=++h)i=l[u],a[u]=i(t,e),a[u]&&(d=!1),0===r&&(a[u]<o[u]?r=1:a[u]>o[u]&&(r=2));return 1===r&&(n=o,o=a,a=n,s=e),d}}),s}},t.hardSides&&O.conditions.push(function(t,e){return null!=t.stats.side&&null!=e.stats.side&&t.stats.side===e.stats.side?1:0}),t.minimizeReMeet&&O.conditions.push(function(t,e){var n,r,o;for(n=0,o=0,r=A.length;r>o;o++)N=A[o],i=t.rounds[N.id].ballot,null!=i&&(i.teams[0]===t&&i.teams[1]===e||i.teams[1]===t&&i.teams[0]===e)&&n++;return n}),q=0,k=D.length,t.algorithm){case 1:for(fe=t.manualPairing,se=0,Z=fe.length;Z>se;se++)R=fe[se],M(R.prop,R.opp);break;case 0:case 2:for(m=ae=0,te=D.length;te>ae;m=++ae)J=D[m],J.stats.paired||(y=O.match(J,function(t){var e,n,r;for(e=n=r=m+1;k>=r?k>n:n>k;e=k>=r?++n:--n)if(t(D[e]))return}),M(J,y,q++));break;case 3:for(d={},W=[],m=le=0,ee=D.length;ee>le;m=++le)J=D[m],J.stats.rank=m,x=J.stats.wins,u=d[x],null==u&&(u=d[x]={teams:[],ballots:x},W.push(u)),u.teams.push(J);if(1===t.evenBrackets)for(ue=0,ne=D.length;ne>ue;ue++){for(J=D[ue],n=0,J.stats.oppRank=0,de=0,re=A.length;re>de;de++)$=A[de],r=J.rounds[$.id].ballot,null!=r&&(H=r.teams[0],B=r.teams[1],H===J&&null!=B&&null!=B.stats&&null!=B.stats.rank?(n++,J.stats.oppRank+=B.stats.rank):B===J&&null!=H&&null!=H.stats&&null!=H.stats.rank&&(n++,J.stats.oppRank+=H.stats.rank));n?J.stats.oppRank/=n:J.stats.oppRank=Number.MAX_VALUE}switch(t.evenBrackets){case 0:E=function(t,e,n){return t.teams.sort(function(t,e){return e.stats.rank-t.stats.rank}),t.teams=_.filter(t.teams,function(t){return e>0&&(null==n||n===t.stats.side)?(e--,S.teams.push(t),!1):!0})};break;case 1:E=function(t,e,n){var r,o,i,s;for(r=m+1,i=W[r],s=[];e&&F>r;)o=i.teams,o.sort(function(t,e){return e.stats.oppRank-t.stats.oppRank}),i.teams=o=_.filter(o,function(r){return e>0&&(null==n||n!==r.stats.side)?(e--,t.teams.push(r),!1):!0}),s.push(i=W[++r]);return s}}for(W.sort(function(t,e){return e.ballots-t.ballots}),F=W.length,m=ce=0,oe=W.length;oe>ce;m=++ce)if(u=W[m],a=l=c=0,s=u.teams.length){for(pe=u.teams,ge=0,ie=pe.length;ie>ge;ge++)switch(J=pe[ge],J.stats.side){case 0:l++;break;case 1:a++;break;case void 0:c++}if(S=W[m+1],null!=S){for(t.hardSides?a>l+c?E(u,a-l-c,1):l>a+c?E(u,l-a-c,0):1&s&&E(u,1):1&s&&E(u,1),b=m+1;null!=S&&0===S.length;)S=W[++b];null!=S&&(s=u.teams.length,j=S.teams,s<2*t.matchesPerBracket&&(u.teams.forEach(function(t){return j.push(t)}),u.teams.length=0))}for(u.teams.sort(function(t,e){return t.stats.rank-e.stats.rank}),me=u.teams,ve=0,K=me.length;K>ve;ve++)J=me[ve],J.stats.paired||(y=O.match(J,function(t){var e,n,r;for(n=u.teams,r=n.length-1;r>=0;r+=-1)if(e=n[r],t(e))return}),M(J,y,q++))}}return null!=h&&M(h,null,q),this.paired=!0,this.assignRooms(),t.shuffleRooms&&t.algorithm&&this.shuffleRooms(),this.assignJudges()},s.prototype.assignJudges=function(){var t,e,r,o,i,s,a,l,u,d,c,h,f,p,m,g,v,b,y,w,k,C,x,j,S,R,I,M,A,T,E,O,P,$;for(u=this.id,i=_.sortBy(_.shuffle(_.filter(this.ballots,function(t){return!t.locked&&t.teams[0]&&t.teams[1]})),function(t){return t.skillIndex}),x=0,I=i.length;I>x;x++){for(r=i[x],O=r.judges,j=0,M=O.length;M>j;j++)d=O[j],d.rounds[u].ballot=null;for(P=r.shadows,S=0,A=P.length;A>S;S++)d=P[S],d.rounds[u].ballot=null;r.judges=[],r.shadows=[]}if(c=_.shuffle(_.filter(this.judges,function(t){var e;return e=t.rounds[u],e.participates&&!e.ballot&&t.rank!==n.shadowRank})),k=_.shuffle(_.filter(this.judges,function(t){var e;return e=t.rounds[u],e.participates&&!e.ballot&&t.rank===n.shadowRank})),a=this.freeJudges=[],c.sort(function(t,e){return t.rank-e.rank}),g=i.length,v=c.length,g>v){for(C=g-v,k.length<C&&(C=k.length),l=R=0;C>=0?C>R:R>C;l=C>=0?++R:--R)c.push(k[l]);k.splice(0,C)}for(o=this.ballotsPerMatchSolved(),b=this.maxPanelSizeSolved(),m=this.maxShadowJudgesSolved(),p=this.maxMainJudgesSolved(),t=function(t,e,n){var r;return null==n&&(n=!1),n?e.shadows.push(t):e.judges.push(t),r=t.rounds[u],r.ballot=e,r.shadow=n},s=function(){return 0},w=this.judgeRules,h=this.tournament.judgeRules,e=function(e,n,o,s,a){var l,c,f,p,m,v,b,y,k,C,x,j,S;for(C=0,y=i.length;y>C;C++)r=i[C],r.maxJudgeCount=a(r),r.judgeCount=0;for(v=0,f=m=e.length;f&&v!==g;)for(v=0,j=n?-1:1,j>0?(x=0,k=i.length):x=i.length-1;(j>0?k>x:x>=0)&&(r=i[x],r.maxJudgeCount<=r.judgeCount?v++:(r.judgeCount++,f--),f);x+=j);for(l=1,S=[];l;)l=0,S.push(function(){var n,a,f,m,g,v;for(g=o?-1:1,v=[],g>0?(f=0,n=i.length):f=i.length-1;g>0?n>f:f>=0;f+=g)if(r=i[f],!(r.judgeCount<=0)){for(c=null,p=Number.MAX_VALUE,m=0,a=e.length;a>m&&(d=e[m],null!=d.rounds[u].ballot||(b=w.compatibilityFactor(d,r,h),!(p>b)||(p=b,c=d,b)));m++);t(c,r,s),r.judgeCount--,v.push(l++)}return v}());return S},f=o,f>b&&(f=b),f>p&&(f=p),e(c,this.judgeMainOrderSolved(),this.judgeMainPrioritySolved(),!1,function(){return f}),c.forEach(function(t){return null==t.rounds[u].ballot?a.push(t):void 0}),y=this.judgeShadowReportSolved(),e(y?a.concat(k):k,this.judgeShadowOrderSolved(),this.judgeShadowPrioritySolved(),!0,function(t){var e;return e=b-t.judges.length,e>m?m:e}),y&&(a.length=0,c.forEach(function(t){return null==t.rounds[u].ballot?a.push(t):void 0})),k.forEach(function(t){return null==t.rounds[u].ballot?a.push(t):void 0}),$=[],E=0,T=i.length;T>E;E++)r=i[E],delete r.maxJudgeCount,$.push(delete r.judgeCount);return $},s.prototype.assignRooms=function(){var t,e,n,r,o,i,s,a,l,u,d;for(e=_.filter(this.ballots,function(t){return!t.locked}),s=[],a=0,u=e.length;u>a;a++)t=e[a],null!=t.room&&s.push(t.room);for(s=s.concat(this.freeRooms),o=s.length,r=this.id,n=l=0,d=e.length;d>l&&(t=e[n],!(n>=o));n=++l)i=s[n],i.rounds[r].ballot=t,t.room=i;return s.splice(0,e.length),this.freeRooms=s},s.prototype.shuffleRooms=function(){var t,e,n,r,o,i,s,a,l,u,d,c,h,f;for(r=this.id,o=_.filter(this.ballots,function(t){return t.locked}),e=_.filter(this.ballots,function(t){return!t.locked}),l=_.filter(_.map(e,function(t){return t.room}),function(t){return t}),e=_.shuffle(e),s=l.length,n=u=0,c=e.length;c>u;n=++u)t=e[n],s>n?(a=l[n],a.rounds[r].ballot=t,t.room=a):t.room=null,this.ballots[n]=t;for(i=e.length,f=[],n=d=0,h=o.length;h>d;n=++d)t=o[n],f.push(this.ballots[n+i]=t);return f},s.prototype.toJSON=function(){var e,n,r,o,i,s;for(e=t.copyObject(this,["tournament"]),e.teams=t.packCycles(this.teams,this.tournament.teams),e.judges=t.packCycles(this.judges,this.tournament.judges),e.freeJudges=t.packCycles(this.freeJudges,this.tournament.judges),e.rooms=t.packCycles(this.rooms,this.tournament.rooms),e.freeRooms=t.packCycles(this.freeRooms,this.tournament.rooms),e.rankFrom={all:this.rankFrom.all},s=this.tournament.rounds,o=0,i=s.length;i>o;o++)n=s[o],r=this.rankFrom[n.id],null!=r&&(e.rankFrom[id]=r);return e},s.prototype.destroy=function(){var t,e,n,r,o,i,s,a,l,u,d,c,h,f;for(t=this.id,d=this.tournament.teams,o=0,a=d.length;a>o;o++)r=d[o],delete r.rounds[t];for(c=this.tournament.judges,i=0,l=c.length;l>i;i++)e=c[i],delete e.rounds[t];for(h=this.tournament.rooms,f=[],s=0,u=h.length;u>s;s++)n=h[s],f.push(delete n.rounds[t]);return f},s.allAlgos=[0,1,2,3],s.initialAlgos=[0,1],s.algoName=["Random","Manual","High-High Power Pairing","High-Low Power Pairing"],s}()})}).call(this);
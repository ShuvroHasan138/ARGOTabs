(function(){define(["util","ballot","judge","sorter","team","underscore"],function(e,t,n,r,o){var i;return i=function(){function i(e,n){var o,i,s,a,l,u,d,c,h,f,p,m,g,v,b,y,w,k,x;if(this.tournament=e,n)for(a in n)d=n[a],this[a]=d;if(null==this.id&&(this.id=Math.floor(1e8*Math.random())),null==this.tableOpts&&(this.tableOpts={}),null==this.teams&&(this.teams=[]),null==this.judges&&(this.judges=[]),null==this.freeJudges&&(this.freeJudges=[]),null==this.rooms&&(this.rooms=[]),null==this.freeRooms&&(this.freeRooms=[]),null==this.ballots&&(this.ballots=[]),null==this.ballotsPerMatch&&(this.ballotsPerMatch=null),null==this.maxMainJudges&&(this.maxMainJudges=null),null==this.maxShadowJudges&&(this.maxShadowJudges=null),null==this.maxPanelSize&&(this.maxPanelSize=null),null==this.inheritPairRank&&(this.inheritPairRank=!0),null==this.allowShadows&&(this.allowShadows=null),this.pairRankSorter=r.teamRankSorter(this.pairRankSorter),null==this.rankFrom&&(this.rankFrom={all:!0}),n)for(y=this.ballots,i=c=0,m=y.length;m>c;i=++c)o=y[i],this.ballots[i]=new t(this,o);else{for(w=this.tournament.teams,h=0,g=w.length;g>h;h++)u=w[h],this.registerTeam(u);for(k=this.tournament.judges,f=0,v=k.length;v>f;f++)s=k[f],this.registerJudge(s),s.rounds[this.id].participates=!0,this.freeJudges.push(s);for(x=this.tournament.rooms,p=0,b=x.length;b>p;p++)l=x[p],this.registerRoom(l)}}return i.prototype.ballotsPerMatchSolved=function(){return null!=this.ballotsPerMatch?this.ballotsPerMatch:this.tournament.ballotsPerMatch},i.prototype.maxMainJudgesSolved=function(){return null!=this.maxMainJudges?this.maxMainJudges:this.tournament.maxMainJudges},i.prototype.maxShadowJudgesSolved=function(){return null!=this.maxShadowJudges?this.maxShadowJudages:this.tournament.maxShadowJudges},i.prototype.maxPanelSizeSolved=function(){return null!=this.maxPanelSize?this.maxPanelSize:this.tournament.maxPanelSize},i.prototype.pairRankSorterSolved=function(){return null!=this.pairRankSorter?this.pairRankSorter:this.tournament.pairRankSorter},i.prototype.allowShadowsSolved=function(){return null!=this.allowShadows?this.allowShadows:this.tournament.allowShadows},i.prototype.unpackCycles=function(){var t,n,r,o,i;for(e.unpackCycles(this.teams,this.tournament.teams),e.unpackCycles(this.judges,this.tournament.judges),e.unpackCycles(this.freeJudges,this.tournament.judges),e.unpackCycles(this.rooms,this.tournament.rooms),e.unpackCycles(this.freeRooms,this.tournament.rooms),o=this.ballots,i=[],n=0,r=o.length;r>n;n++)t=o[n],i.push(t.unpackCycles());return i},i.prototype.previousRounds=function(){var e,t,n,r,o,i,s,a;if(e=[],this.rankFrom.all)for(s=this.tournament.rounds,n=0,o=s.length;o>n&&(t=s[n],t!==this);n++)t.paired&&e.push(t);else for(a=this.tournament.rounds,r=0,i=a.length;i>r;r++)t=a[r],t.paired&&this.rankFrom[t.id]&&e.push(t);return e},i.prototype.registerJudge=function(e){var t;return t=this.id,null==e.rounds[t]?(e.rounds[t]={participates:!1},this.judges.push(e)):void 0},i.prototype.unregisterJudge=function(t){var n;return n=t.rounds[this.id],null!=n&&null!=n.ballot&&(n.shadow?e.arrayRemove(n.ballot.shadows,t):e.arrayRemove(n.ballot.judges,t)),e.arrayRemove(this.judges,t),e.arrayRemove(this.freeJudges,t)},i.prototype.registerTeam=function(e){var t;return t=this.id,null==e.rounds[t]?(e.rounds[t]={participates:!0},this.teams.push(e)):void 0},i.prototype.unregisterTeam=function(t){return e.arrayRemove(this.teams,t)},i.prototype.registerRoom=function(e){var t;return t=this.id,null==e.rounds[t]?(e.rounds[t]={participates:!0},this.rooms.push(e),this.freeRooms.push(e)):void 0},i.prototype.unregisterRoom=function(t){var n;return n=t.rounds[this.id],null!=n&&null!=n.ballot&&(n.ballot.room=null),e.arrayRemove(this.rooms,t),e.arrayRemove(this.freeRooms,t)},i.prototype.sortByRank=function(e){var t;return o.calculateStats(e,this.previousRounds()),t=this.pairRankSorterSolved().compareObjects,e.sort(function(e,n){return t(e.stats,n.stats)})},i.prototype.pairingTeams=function(){var e,t;return e=this.id,t=_.filter(this.teams,function(t){return t.rounds[e].participates})},i.prototype.pair=function(e){var n,r,o,i,s,a,l,u,d,c,h,f,p,m,g,v,b,y,w=this;switch(h=this.pairingTeams(),e.algorithm?this.sortByRank(h):h=_.shuffle(h),1&h.length&&h.push(null),i=this.id,l=_.filter(this.rooms,function(e){var t;return t=e.rounds[i],t.ballot=null,t.participates}),u=0,d=l.length,r=e.shuffleSides||1!==e.algorithm,n=e.balanceSides,null==n&&(n=!0),a=function(e,n,o){var s,a,c;return null==o&&(o=0),a=new t(w),a.teams[0]=e,a.teams[1]=n,a.skillIndex=o,null==e||null==n?(null==e&&(s=e,e=n,n=s,a.teams[0]=e,a.teams[1]=n),a.locked=!0):r&&(c=.5,Math.random()>c&&(a.teams[0]=n,a.teams[1]=e)),d>u&&!a.locked&&(a.room=l[u],a.room.rounds[i].ballot=a,u++),w.ballots.push(a),null!=e&&(e.rounds[i].ballot=a),null!=n?n.rounds[i].ballot=a:void 0},c=0,e.algorithm){case 0:for(o=f=0,v=h.length;v>f;o=f+=2)a(h[o],h[o+1]);break;case 1:for(b=e.manualPairing,p=0,g=b.length;g>p;p++)s=b[p],a(s.prop,s.opp);break;case 3:for(o=m=0,y=h.length;y>m;o=m+=2)a(h[o],h[o+1],c++)}return this.paired=!0,l.splice(0,u),this.freeRooms=l,e.shuffleRooms&&this.shuffleRooms(),this.assignJudges()},i.prototype.assignJudges=function(){var e,t,r,o,i,s,a,l,u,d,c,h,f,p,m,g,v,b,y,w,k,x,C,j,I,S,R,T,A,E,$,q;for(a=this.id,i=_.sortBy(_.shuffle(_.filter(this.ballots,function(e){return!e.locked&&e.teams[0]&&e.teams[1]},function(e){return e.skillIndex}))),y=0,C=i.length;C>y;y++){for(t=i[y],E=t.judges,w=0,j=E.length;j>w;w++)l=E[w],l.rounds[a].ballot=null;for($=t.shadows,k=0,I=$.length;I>k;k++)l=$[k],l.rounds[a].ballot=null;t.judges=[],t.shadows=[]}if(d=_.shuffle(_.filter(this.judges,function(e){var t;return t=e.rounds[a],t.participates&&!t.ballot&&e.rank!==n.shadowRank})),v=_.shuffle(_.filter(this.judges,function(e){var t;return t=e.rounds[a],t.participates&&!t.ballot&&e.rank===n.shadowRank})),this.freeJudges=[],d.sort(function(e,t){return e.rank<t.rank}),f=i.length,p=d.length,f>p){for(b=f-p,v.length<b&&(b=v.length),s=x=0;b>=0?b>x:x>b;s=b>=0?++x:--x)d.push(v[s]);v.splice(0,b)}for(o=this.ballotsPerMatchSolved(),m=this.maxPanelSizeSolved(),h=this.maxShadowJudgesSolved(),c=this.maxMainJudgesSolved(),e=function(e,t,n){var r;return null==n&&(n=!1),n?t.shadows.push(e):t.judges.push(e),r=e.rounds[a],r.ballot=t,r.shadow=n},s=0,T=0,S=d.length;S>T;T++)l=d[T],r=i[s],u=r.judges.length,g=r.shadows.length,u+g>=m||(o>u&&c>u?e(l,r):h>g?e(l,r,!0):this.freeJudges.push(l),++s>=f&&(s=0));for(q=[],A=0,R=v.length;R>A;A++)l=v[A],r=i[s],u=r.judges.length,g=r.shadows.length,m>u+g&&h>g?e(l,r,!0):this.freeJudges.push(l),++s>=f?q.push(s=0):q.push(void 0);return q},i.prototype.assignRooms=function(){var e,t,n,r,o,i,s,a,l,u,d;for(t=_.filter(this.ballots,function(e){return!e.locked}),s=[],a=0,u=t.length;u>a;a++)e=t[a],null!=e.room&&s.push(e.room);for(s=s.concat(this.freeRooms),o=s.length,r=this.id,n=l=0,d=t.length;d>l&&(e=t[n],!(n>=o));n=++l)i=s[n],i.rounds[r].ballot=e,e.room=i;return s.splice(0,t.length),this.freeRooms=s},i.prototype.shuffleRooms=function(){var e,t,n,r,o,i,s,a,l,u,d,c,h;for(r=this.id,o=_.filter(this.ballots,function(e){return e.locked}),t=_.shuffle(_.filter(this.ballots,function(e){return!e.locked})),a=_.map(t,function(e){return e.room}),n=l=0,d=t.length;d>l;n=++l)e=t[n],s=a[n],s.rounds[r].ballot=e,e.room=s,this.ballots[n]=e;for(i=t.length,h=[],n=u=0,c=o.length;c>u;n=++u)e=o[n],h.push(this.ballots[n+i]=e);return h},i.prototype.toJSON=function(){var t,n,r,o,i,s;for(t=e.copyObject(this,["tournament"]),t.teams=e.packCycles(this.teams,this.tournament.teams),t.judges=e.packCycles(this.judges,this.tournament.judges),t.freeJudges=e.packCycles(this.freeJudges,this.tournament.judges),t.rooms=e.packCycles(this.rooms,this.tournament.rooms),t.freeRooms=e.packCycles(this.freeRooms,this.tournament.rooms),t.rankFrom={all:this.rankFrom.all},s=this.tournament.rounds,o=0,i=s.length;i>o;o++)n=s[o],r=this.rankFrom[n.id],null!=r&&(t.rankFrom[id]=r);return t},i.prototype.destroy=function(){var e,t,n,r,o,i,s,a,l,u,d,c,h,f;for(e=this.id,d=this.tournament.teams,o=0,a=d.length;a>o;o++)r=d[o],delete r.rounds[e];for(c=this.tournament.judges,i=0,l=c.length;l>i;i++)t=c[i],delete t.rounds[e];for(h=this.tournament.rooms,f=[],s=0,u=h.length;u>s;s++)n=h[s],f.push(delete n.rounds[e]);return f},i.allAlgos=[0,1,2,3],i.initialAlgos=[0,1],i.algoName=["Random","Manual","High-Low","Power Pairing"],i}()})}).call(this);